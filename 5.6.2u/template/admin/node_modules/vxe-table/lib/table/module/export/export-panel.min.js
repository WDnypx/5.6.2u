Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ui=require("../../../ui"),_xeUtils=_interopRequireDefault(require("xe-utils")),_utils=require("../../../ui/src/utils"),_log=require("../../../ui/src/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let{getI18n,getIcon,globalMixins,renderEmptyElement}=_ui.VxeUI;var _default=exports.default={name:"VxeTableExportPanel",mixins:[globalMixins.sizeMixin],props:{defaultOptions:Object,storeData:Object},components:{},inject:{$xeTable:{default:null}},data(){return{isAll:!1,isIndeterminate:!1,loading:!1}},computed:{checkedAll(){return this.storeData.columns.every(e=>e.checked)},showSheet(){return-1<["html","xml","xlsx","pdf"].indexOf(this.defaultOptions.type)},supportMerge(){var{storeData:e,defaultOptions:t}=this;return!t.original&&"current"===t.mode&&(e.isPrint||-1<["html","xlsx"].indexOf(t.type))},supportStyle(){var e=this.defaultOptions;return!e.original&&-1<["xlsx"].indexOf(e.type)}},created(){let e=_ui.VxeUI.getComponent("VxeModal"),t=_ui.VxeUI.getComponent("VxeButton"),l=_ui.VxeUI.getComponent("VxeSelect"),o=_ui.VxeUI.getComponent("VxeInput"),i=_ui.VxeUI.getComponent("VxeCheckbox");this.$nextTick(()=>{e||(0,_log.errLog)("vxe.error.reqComp",["vxe-modal"]),t||(0,_log.errLog)("vxe.error.reqComp",["vxe-button"]),l||(0,_log.errLog)("vxe.error.reqComp",["vxe-select"]),o||(0,_log.errLog)("vxe.error.reqComp",["vxe-input"]),i||(0,_log.errLog)("vxe.error.reqComp",["vxe-checkbox"])})},render(n){let l=this.$xeTable,o=l.$xeGrid,{_e:i,checkedAll:r,isAll:s,isIndeterminate:a,showSheet:p,supportMerge:x,supportStyle:c,defaultOptions:d,storeData:h}=this,{hasTree:v,hasMerge:u,isPrint:g,hasColgroup:m,columns:b}=h,k=d.isHeader;var e=d.slots||{};let C=e.top,E=e.bottom,f=e.default,t=e.footer,I=e.parameter,O=[];return _xeUtils.default.eachTree(b,e=>{var t=(0,_utils.formatText)(e.getTitle(),1),l=e.children&&e.children.length,o=e.checked,i=e.halfChecked,r="html"===e.type;O.push(n("li",{class:["vxe-table-export--panel-column-option","level--"+e.level,{"is--group":l,"is--checked":o,"is--indeterminate":i,"is--disabled":e.disabled}],attrs:{title:t},on:{click:()=>{e.disabled||this.changeOption(e)}}},[n("span",{class:["vxe-checkbox--icon",i?getIcon().TABLE_CHECKBOX_INDETERMINATE:o?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]}),r?n("span",{key:"1",class:"vxe-checkbox--label",domProps:{innerHTML:t}}):n("span",{key:"0",class:"vxe-checkbox--label"},t)]))}),n("vxe-modal",{ref:"modal",props:{id:"VXE_EXPORT_MODAL",value:h.visible,title:getI18n(g?"vxe.export.printTitle":"vxe.export.expTitle"),width:660,minWidth:500,minHeight:400,mask:!0,lockView:!0,showFooter:!0,escClosable:!0,maskClosable:!0,showMaximize:!0,resize:!0,loading:this.loading},on:{input(e){h.visible=e},show:this.showEvent},scopedSlots:{default:()=>{var e={$table:l,$grid:o,options:d,columns:b,params:d.params},t="empty"===d.mode;return n("div",{class:"vxe-table-export--panel"},[C?n("div",{class:"vxe-table-export--panel-top"},l.callSlot(C,e,n)):renderEmptyElement(this),n("div",{class:"vxe-table-export--panel-body"},f?l.callSlot(f,e,n):[n("table",{attrs:{class:"vxe-table-export--panel-table",cellspacing:0,cellpadding:0,border:0}},[n("tbody",[[g?i():n("tr",[n("td",getI18n("vxe.export.expName")),n("td",[n("vxe-input",{ref:"filename",props:{value:d.filename,type:"text",clearable:!0,placeholder:getI18n("vxe.export.expNamePlaceholder")},on:{modelValue(e){d.filename=e}}})])]),g?i():n("tr",[n("td",getI18n("vxe.export.expType")),n("td",[n("vxe-select",{props:{value:d.type,options:h.typeList},on:{modelValue(e){d.type=e}}})])]),g||p?n("tr",[n("td",getI18n("vxe.export.expSheetName")),n("td",[n("vxe-input",{ref:"sheetname",props:{value:d.sheetName,type:"text",clearable:!0,placeholder:getI18n("vxe.export.expSheetNamePlaceholder")},on:{modelValue(e){d.sheetName=e}}})])]):i(),n("tr",[n("td",getI18n("vxe.export.expMode")),n("td",[n("vxe-select",{props:{value:d.mode,options:h.modeList},on:{modelValue(e){d.mode=e}}})])]),n("tr",[n("td",[getI18n("vxe.export.expColumn")]),n("td",[n("div",{class:"vxe-table-export--panel-column"},[n("ul",{class:"vxe-table-export--panel-column-header"},[n("li",{class:["vxe-table-export--panel-column-option",{"is--checked":s,"is--indeterminate":a}],attrs:{title:getI18n("vxe.table.allTitle")},on:{click:this.allColumnEvent}},[n("span",{class:["vxe-checkbox--icon",a?getIcon().TABLE_CHECKBOX_INDETERMINATE:s?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]}),n("span",{class:"vxe-checkbox--label"},getI18n("vxe.export.expCurrentColumn"))])]),n("ul",{class:"vxe-table-export--panel-column-body"},O)])])]),n("tr",[n("td",getI18n("vxe.export.expOpts")),I?n("td",[n("div",{class:"vxe-table-export--panel-option-row"},l.callSlot(I,e,n))]):n("td",[n("div",{class:"vxe-table-export--panel-option-row"},[n("vxe-checkbox",{props:{value:t||k,disabled:t,title:getI18n("vxe.export.expHeaderTitle"),content:getI18n("vxe.export.expOptHeader")},on:{input(e){d.isHeader=e}}}),n("vxe-checkbox",{props:{value:!!k&&d.isTitle,disabled:!k,title:getI18n("vxe.export.expTitleTitle"),content:getI18n("vxe.export.expOptTitle")},on:{input(e){d.isTitle=e}}}),n("vxe-checkbox",{props:{value:!!(k&&m&&x)&&d.isColgroup,disabled:!k||!m||!x,title:getI18n("vxe.export.expColgroupTitle"),content:getI18n("vxe.export.expOptColgroup")},on:{input(e){d.isColgroup=e}}})]),n("div",{class:"vxe-table-export--panel-option-row"},[n("vxe-checkbox",{props:{value:!t&&d.original,disabled:t,title:getI18n("vxe.export.expOriginalTitle"),content:getI18n("vxe.export.expOptOriginal")},on:{input(e){d.original=e}}}),n("vxe-checkbox",{props:{value:!!(u&&x&&r)&&d.isMerge,disabled:t||!u||!x||!r,title:getI18n("vxe.export.expMergeTitle"),content:getI18n("vxe.export.expOptMerge")},on:{input(e){d.isMerge=e}}}),g?i():n("vxe-checkbox",{props:{value:!!c&&d.useStyle,disabled:!c,title:getI18n("vxe.export.expUseStyleTitle"),content:getI18n("vxe.export.expOptUseStyle")},on:{input(e){d.useStyle=e}}}),n("vxe-checkbox",{props:{value:!!v&&d.isAllExpand,disabled:t||!v,title:getI18n("vxe.export.expAllExpandTitle"),content:getI18n("vxe.export.expOptAllExpand")},on:{input(e){d.isAllExpand=e}}})]),n("div",{class:"vxe-table-export--panel-option-row"},[n("vxe-checkbox",{props:{value:d.isFooter,disabled:!h.hasFooter,title:getI18n("vxe.export.expFooterTitle"),content:getI18n("vxe.export.expOptFooter")},on:{input(e){d.isFooter=e}}})])])])]])])]),E?n("div",{class:"vxe-table-export--panel-bottom"},l.callSlot(E,e,n)):renderEmptyElement(this)])},footer:()=>{var e={$table:l,$grid:o,options:d,columns:b,params:d.params};return n("div",{class:"vxe-table-export--panel-footer"},t?l.callSlot(t,e,n):[n("div",{class:"vxe-table-export--panel-btns"},[n("vxe-button",{props:{content:getI18n("vxe.export.expCancel")},on:{click:this.cancelEvent}}),n("vxe-button",{ref:"confirmBtn",props:{status:"primary",content:getI18n(g?"vxe.export.expPrint":"vxe.export.expConfirm")},on:{click:this.confirmEvent}})])])}}})},methods:{changeOption(e){let t=!e.checked;_xeUtils.default.eachTree([e],e=>{e.checked=t,e.halfChecked=!1}),this.handleOptionCheck(e),this.checkStatus()},handleOptionCheck(t){var e=_xeUtils.default.findTree(this.storeData.columns,e=>e===t);e&&e.parent&&(e=e.parent,e.children)&&e.children.length&&(e.checked=e.children.every(e=>e.checked),e.halfChecked=!e.checked&&e.children.some(e=>e.checked||e.halfChecked),this.handleOptionCheck(e))},checkStatus(){var e=this.storeData.columns;this.isAll=e.every(e=>e.disabled||e.checked),this.isIndeterminate=!this.isAll&&e.some(e=>!e.disabled&&(e.checked||e.halfChecked))},allColumnEvent(){let t=!this.isAll;_xeUtils.default.eachTree(this.storeData.columns,e=>{e.disabled||(e.checked=t,e.halfChecked=!1)}),this.isAll=t,this.checkStatus()},showEvent(){this.$nextTick(()=>{var e=this.$refs,e=e.filename||e.sheetname||e.confirmBtn;e&&e.focus()}),this.checkStatus()},getExportOption(){var{checkedAll:e,storeData:t,defaultOptions:l,supportMerge:o}=this,{hasMerge:t,columns:i}=t,i=_xeUtils.default.searchTree(i,e=>e.checked,{children:"children",mapChildren:"childNodes",original:!0});return Object.assign({},l,{columns:i,isMerge:!!(t&&o&&e)&&l.isMerge})},cancelEvent(){this.storeData.visible=!1},confirmEvent(e){this.storeData.isPrint?this.printEvent(e):this.exportEvent(e)},printEvent(){var e=this.$parent;this.storeData.visible=!1,e.print(Object.assign({},e.printOpts,this.getExportOption()))},exportEvent(){var e=this.$xeTable,t=e.exportOpts;this.loading=!0,e.exportData(Object.assign({},t,this.getExportOption())).then(()=>{this.loading=!1,this.storeData.visible=!1}).catch(()=>{this.loading=!1})}}};