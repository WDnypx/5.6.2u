Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ui=require("../../../ui"),_utils=require("../../../ui/src/utils"),_dom=require("../../../ui/src/dom"),_log=require("../../../ui/src/log"),_xeUtils=_interopRequireDefault(require("xe-utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let{getI18n,getIcon,renderEmptyElement}=_ui.VxeUI;function showDropTip(e,t,l,o,s){var i,r,a=e.prevDragToChild,n=e.$refs.bodyElemRef;n&&(i=n.getBoundingClientRect(),l&&(r=e.$refs.refDragLineElem)&&(o?(l=l.getBoundingClientRect(),r.style.display="block",r.style.top=Math.max(1,l.y+n.scrollTop-i.y)+"px",r.style.height=l.height+"px",r.style.width=l.width+"px",r.setAttribute("drag-pos",s),r.setAttribute("drag-to-child",a?"y":"n")):r.style.display=""),l=e.$refs.refDragTipElem)&&(l.style.display="block",l.style.top=Math.min(n.clientHeight+n.scrollTop-l.clientHeight,t.clientY+n.scrollTop-i.y)+"px",l.style.left=Math.min(n.clientWidth+n.scrollLeft-l.clientWidth,t.clientX+n.scrollLeft-i.x)+"px",l.setAttribute("drag-status",o?a?"sub":"normal":"disabled"))}function hideDropTip(e){var t=e.$refs.refDragTipElem,e=e.$refs.refDragLineElem;t&&(t.style.display=""),e&&(e.style.display="")}let renderDragTip=(e,t)=>{var t=t.$xeTable,l=t.dragColumnRef;return e("div",{},[e("div",{ref:"refDragLineElem",class:["vxe-table-custom-popup--drag-line",{"is--guides":t.computeColumnDragOpts.showGuidesStatus}]}),e("div",{ref:"refDragTipElem",class:"vxe-table-custom-popup--drag-tip"},[e("div",{class:"vxe-table-custom-popup--drag-tip-wrapper"},[e("div",{class:"vxe-table-custom-popup--drag-tip-status"},[e("span",{class:["vxe-table-custom-popup--drag-tip-normal-status",getIcon().TABLE_DRAG_STATUS_ROW]}),e("span",{class:["vxe-table-custom-popup--drag-tip-sub-status",getIcon().TABLE_DRAG_STATUS_SUB_ROW]}),e("span",{class:["vxe-table-custom-popup--drag-tip-disabled-status",getIcon().TABLE_DRAG_DISABLED]})]),e("div",{class:"vxe-table-custom-popup--drag-tip-content"},getI18n("vxe.custom.cstmDragTarget",[l&&"html"!==l.type?l.getTitle():""]))])])])},renderSimplePanel=(d,m)=>{let u=_ui.VxeUI.getComponent("VxeButton");let p=m.$xeTable;var e=p,t=p.$xeGrid,l=m.customStore,{isCustomStatus:e,customColumnList:o}=e,s=p.computeCustomOpts;let v=s.immediate;var i=p.computeColumnDragOpts,r=l.maxHeight;let{checkMethod:x,visibleMethod:g,allowVisible:h,allowSort:b,allowFixed:C,trigger:a,placement:n}=s,E=p.computeIsMaxFixedColumn,T=i.isCrossDrag;var i=s.slots||{},c=i.header,f=i.top,I=i.bottom,_=i.default,i=i.footer;let D=[];var y={},O=l.isAll,k=l.isIndeterminate,t=("hover"===a&&(y.mouseenter=m.handleWrapperMouseenterEvent,y.mouseleave=m.handleWrapperMouseleaveEvent),{$table:p,$grid:t,columns:o,isAllChecked:O,isAllIndeterminate:k,isCustomStatus:e});return _xeUtils.default.eachTree(o,(t,e,l,o,s)=>{if(!g||g({$table:p,column:t})){var i=t.renderVisible,r=t.halfVisible,a=t.children&&t.children.length,n=(0,_utils.formatText)(t.getTitle(),1);let e=!!x&&!x({$table:p,column:t});var c=!i;D.push(d("li",{key:t.id,attrs:{colid:t.id},class:["vxe-table-custom--option","level--"+t.level,{"is--hidden":e||c,"is--group":a}],on:{dragstart:m.sortDragstartEvent,dragend:m.sortDragendEvent,dragover:m.sortDragoverEvent}},[h?d("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":i,"is--indeterminate":r,"is--disabled":e}],attrs:{title:getI18n("vxe.custom.setting.colVisible")},on:{click:()=>{e||m.changeCheckboxOption(t)}}},[d("span",{class:["vxe-checkbox--icon",r?getIcon().TABLE_CHECKBOX_INDETERMINATE:i?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]})]):renderEmptyElement(p),d("div",{class:"vxe-table-custom--name-option"},[b&&(T&&v||1===t.level)?d("div",{class:"vxe-table-custom--sort-option"},[d("span",{class:["vxe-table-custom--sort-btn",{"is--disabled":e||c||t.renderFixed}],attrs:{title:getI18n("vxe.custom.setting.sortHelpTip")},on:e||c||t.renderFixed?{}:{mousedown:m.sortMousedownEvent,mouseup:m.sortMouseupEvent}},[d("i",{class:getIcon().TABLE_CUSTOM_SORT})])]):renderEmptyElement(p),"html"===t.type?d("div",{key:"1",class:"vxe-table-custom--checkbox-label",domProps:{innerHTML:n}}):d("div",{key:"0",class:"vxe-table-custom--checkbox-label",attrs:{title:n}},n)]),!s&&C?d("div",{class:"vxe-table-custom--fixed-option"},[d(u,{props:{mode:"text",icon:"left"===t.renderFixed?getIcon().TOOLBAR_TOOLS_FIXED_LEFT_ACTIVE:getIcon().TOOLBAR_TOOLS_FIXED_LEFT,status:"left"===t.renderFixed?"primary":"",disabled:e||c||E&&!t.renderFixed,title:getI18n("left"===t.renderFixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedLeft")},on:{click:()=>{m.changeFixedOption(t,"left")}}}),d(u,{props:{mode:"text",icon:"right"===t.renderFixed?getIcon().TOOLBAR_TOOLS_FIXED_RIGHT_ACTIVE:getIcon().TOOLBAR_TOOLS_FIXED_RIGHT,status:"right"===t.renderFixed?"primary":"",disabled:e||c||E&&!t.renderFixed,title:getI18n("right"===t.renderFixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedRight")},on:{click:()=>{m.changeFixedOption(t,"right")}}})]):renderEmptyElement(p)]))}}),d("div",{key:"simple",class:["vxe-table-custom-wrapper","placement--"+n,{"is--active":l.visible}],style:r&&!["left","right"].includes(n||"")?{maxHeight:r+"px"}:{}},l.visible?[d("div",{class:"vxe-table-custom--header"},c?p.callSlot(c,t,d):[d("ul",{class:"vxe-table-custom--panel-list"},[d("li",{class:"vxe-table-custom--option"},[h?d("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":O,"is--indeterminate":k}],attrs:{title:getI18n("vxe.table.allTitle")},on:{click:m.allOptionEvent}},[d("span",{class:["vxe-checkbox--icon",k?getIcon().TABLE_CHECKBOX_INDETERMINATE:O?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]}),d("span",{class:"vxe-checkbox--label"},getI18n("vxe.toolbar.customAll"))]):d("span",{class:"vxe-checkbox--label"},getI18n("vxe.table.customTitle"))])])]),d("div",{ref:"bodyElemRef",class:"vxe-table-custom--body"},[f?d("div",{class:"vxe-table-custom--panel-top"},p.callSlot(f,t,d)):renderEmptyElement(p),_?d("div",{class:"vxe-table-custom--panel-body"},p.callSlot(_,t,d)):d("transition-group",{class:"vxe-table-custom--panel-list",props:{name:"vxe-table-custom--list",tag:"ul"},on:y},D),I?d("div",{class:"vxe-table-custom--panel-bottom"},p.callSlot(I,t,d)):renderEmptyElement(p),renderDragTip(d,m)]),s.showFooter?d("div",{class:"vxe-table-custom--footer"},i?p.callSlot(i,t,d):[d("div",{class:"vxe-table-custom--footer-buttons"},[d(u,{props:{mode:"text",content:s.resetButtonText||getI18n("vxe.table.customRestore"),disabled:!e},on:{click:m.resetCustomEvent}}),v?d(u,{props:{mode:"text",content:s.closeButtonText||getI18n("vxe.table.customClose")},on:{click:m.cancelCloseEvent}}):d(u,{props:{mode:"text",content:s.resetButtonText||getI18n("vxe.table.customCancel")},on:{click:m.cancelCustomEvent}}),v?renderEmptyElement(p):d(u,{props:{mode:"text",status:"primary",content:s.confirmButtonText||getI18n("vxe.table.customConfirm")},on:{click:m.confirmCustomEvent}})])]):null]:[])},renderPopupPanel=(d,m)=>{var e=_ui.VxeUI.getComponent("VxeModal"),t=_ui.VxeUI.getComponent("VxeDrawer");let l=_ui.VxeUI.getComponent("VxeButton"),u=_ui.VxeUI.getComponent("VxeInput"),p=m,v=m.$xeTable;var o=v,s=v,i=v.$xeGrid;let r=m.customStore,L=o.resizable,{isCustomStatus:a,customColumnList:n}=s,c=v.computeCustomOpts,x=c.immediate;o=v.computeColumnDragOpts;let{mode:M,modalOptions:R,drawerOptions:$,allowVisible:g,allowSort:H,allowFixed:h,allowResizable:b,checkMethod:C,visibleMethod:E}=c,T=v.computeColumnOpts,f=T.maxFixedSize,{minWidth:I,maxWidth:_}=v.computeResizableOpts;var s=Object.assign({},R),D=Object.assign({},$);let y=v.computeIsMaxFixedColumn,W=o.isCrossDrag;o=c.slots||{};let O=o.header,k=o.top,w=o.bottom,S=o.default,B=o.footer,A=[],U=r.isAll,V=r.isIndeterminate,F={$table:v,$grid:i,columns:n,isAllChecked:U,isAllIndeterminate:V,isCustomStatus:a};_xeUtils.default.eachTree(n,(o,s,e,t,i)=>{if(!E||E({$table:v,column:o})){let e=0,t=0;b&&(s={$table:v,column:o,columnIndex:s,$columnIndex:s,$rowIndex:-1},I&&(e=_xeUtils.default.toNumber(_xeUtils.default.isFunction(I)?I(s):I)),_)&&(t=_xeUtils.default.toNumber(_xeUtils.default.isFunction(_)?_(s):_));var s=o.renderVisible,r=o.halfVisible,a=(0,_utils.formatText)(o.getTitle(),1),n=o.children&&o.children.length;let l=!!C&&!C({$table:v,column:o});var c=!s;A.push(d("tr",{key:o.id,attrs:{colid:o.id},class:["vxe-table-custom-popup--row level--"+o.level,{"is--group":n}],on:{dragstart:m.sortDragstartEvent,dragend:m.sortDragendEvent,dragover:m.sortDragoverEvent}},[g?d("td",{class:"vxe-table-custom-popup--column-item col--visible"},[d("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":s,"is--indeterminate":r,"is--disabled":l}],attrs:{title:getI18n("vxe.custom.setting.colVisible")},on:{click:()=>{l||m.changeCheckboxOption(o)}}},[d("span",{class:["vxe-checkbox--icon",r?getIcon().TABLE_CHECKBOX_INDETERMINATE:s?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]})])]):renderEmptyElement(v),d("td",{class:"vxe-table-custom-popup--column-item col--name"},[d("div",{class:"vxe-table-custom-popup--name"},[H?W&&x||1===o.level?d("div",{class:["vxe-table-custom-popup--column-sort-btn",{"is--disabled":l||c||o.renderFixed}],attrs:{title:getI18n("vxe.custom.setting.sortHelpTip")},on:l||c||o.renderFixed?{}:{mousedown:m.sortMousedownEvent,mouseup:m.sortMouseupEvent}},[d("i",{class:getIcon().TABLE_CUSTOM_SORT})]):d("div",{class:"vxe-table-custom-popup--column-sort-placeholder"}):renderEmptyElement(v),"html"===o.type?d("div",{key:"1",class:"vxe-table-custom-popup--title",domProps:{innerHTML:a}}):d("div",{key:"0",class:"vxe-table-custom-popup--title",attrs:{title:a}},a)])]),b?d("td",{class:"vxe-table-custom-popup--column-item col--resizable"},[o.children&&o.children.length||!(_xeUtils.default.isBoolean(o.resizable)?o.resizable:T.resizable||L)?d("span","-"):u?d(u,{props:{type:"integer",immediate:!1,disabled:l||c,value:o.renderResizeWidth,min:e||void 0,max:t||void 0},on:{modelValue(e){o.renderResizeWidth=Math.max(0,Number(e))},change(){m.changeColumnWidth(o)}}}):renderEmptyElement(p)]):renderEmptyElement(v),h?d("td",{class:"vxe-table-custom-popup--column-item col--fixed"},[i?d("span","-"):d("vxe-radio-group",{props:{value:o.renderFixed||"",type:"button",size:"mini",disabled:l||c,options:[{label:getI18n("vxe.custom.setting.fixedLeft"),value:"left",disabled:l||c||y},{label:getI18n("vxe.custom.setting.fixedUnset"),value:"",disabled:l||c},{label:getI18n("vxe.custom.setting.fixedRight"),value:"right",disabled:l||c||y}]},on:{input(e){m.changeFixedOption(o,e)}}})]):renderEmptyElement(v)]))}});o={default:()=>S?v.callSlot(S,F,d):d("div",{ref:"bodyElemRef",class:"vxe-table-custom-popup--body"},[k?d("div",{class:"vxe-table-custom-popup--table-top"},v.callSlot(k,F,d)):renderEmptyElement(v),d("div",{class:"vxe-table-custom-popup--table-wrapper"},[d("table",{},[d("colgroup",{},[g?d("col",{class:"vxe-table-custom-popup--table-col-seq"}):renderEmptyElement(v),d("col",{class:"vxe-table-custom-popup--table-col-title"}),b?d("col",{class:"vxe-table-custom-popup--table-col-width"}):renderEmptyElement(v),h?d("col",{class:"vxe-table-custom-popup--table-col-fixed"}):renderEmptyElement(v)]),d("thead",{},[d("tr",{},[g?d("th",{},[d("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":U,"is--indeterminate":V}],attrs:{title:getI18n("vxe.table.allTitle")},on:{click:m.allOptionEvent}},[d("span",{class:["vxe-checkbox--icon",V?getIcon().TABLE_CHECKBOX_INDETERMINATE:U?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]}),d("span",{class:"vxe-checkbox--label"},getI18n("vxe.toolbar.customAll"))])]):renderEmptyElement(v),d("th",{},getI18n("vxe.custom.setting.colTitle")),b?d("th",{},getI18n("vxe.custom.setting.colResizable")):renderEmptyElement(v),h?d("th",{},getI18n("vxe.custom.setting."+(f?"colFixedMax":"colFixed"),[f])):renderEmptyElement(v)])]),d("transition-group",{class:"vxe-table-custom--panel-list",props:{tag:"tbody",name:"vxe-table-custom--list"}},A)])]),w?d("div",{class:"vxe-table-custom-popup--table-bottom"},v.callSlot(w,F,d)):renderEmptyElement(v),renderDragTip(d,m)]),footer:()=>B?v.callSlot(B,F,d):d("div",{class:"vxe-table-custom-popup--footer"},[d(l,{props:{content:c.resetButtonText||getI18n("vxe.custom.cstmRestore"),disabled:!a},on:{click:m.resetCustomEvent}}),x?d(l,{props:{content:c.resetButtonText||getI18n("vxe.table.customClose")},on:{click:m.cancelCloseEvent}}):d(l,{props:{content:c.resetButtonText||getI18n("vxe.custom.cstmCancel")},on:{click:m.cancelCustomEvent}}),x?renderEmptyElement(v):d(l,{props:{status:"primary",content:c.confirmButtonText||getI18n("vxe.custom.cstmConfirm")},on:{click:m.confirmCustomEvent}})])};return O&&(o.header=()=>v.callSlot(O,F,d)),"drawer"===M?t?d(t,{key:"drawer",props:{className:["vxe-table-custom-drawer-wrapper","vxe-table--ignore-clear",D.className||""].join(" "),value:r.visible,title:D.title||getI18n("vxe.custom.cstmTitle"),width:D.width||Math.min(880,Math.floor(.6*document.documentElement.clientWidth)),position:D.position,resize:!!D.resize,escClosable:!!D.escClosable,maskClosable:!!D.maskClosable,destroyOnClose:!0,showFooter:!0},on:{input(e){r.visible=e}},scopedSlots:o}):renderEmptyElement(p):e?d(e,{key:"modal",props:{className:["vxe-table-custom-popup-wrapper","vxe-table--ignore-clear",s.className||""].join(" "),value:r.visible,title:s.title||getI18n("vxe.custom.cstmTitle"),width:s.width||Math.min(880,document.documentElement.clientWidth),minWidth:s.minWidth||700,height:s.height||Math.min(680,document.documentElement.clientHeight),minHeight:s.minHeight||400,showZoom:s.showZoom,showMaximize:s.showMaximize,showMinimize:s.showMinimize,mask:s.mask,lockView:s.lockView,resize:s.resize,escClosable:!!s.escClosable,maskClosable:!!s.maskClosable,destroyOnClose:!0,showFooter:!0},on:{input(e){r.visible=e}},scopedSlots:o}):renderEmptyElement(p)};var _default=exports.default={name:"VxeTableCustomPanel",props:{customStore:{type:Object,default:()=>({})}},inject:{$xeTable:{default:null}},data(){return{prevDragCol:void 0,prevDragToChild:!1,prevDragPos:null}},computed:{},created(){let t=_ui.VxeUI.getComponent("VxeModal"),l=_ui.VxeUI.getComponent("VxeDrawer"),o=_ui.VxeUI.getComponent("VxeButton"),s=_ui.VxeUI.getComponent("VxeNumberInput"),i=_ui.VxeUI.getComponent("VxeRadioGroup");this.$nextTick(()=>{var e=this.$xeTable.customOpts,e=e.mode;t||"modal"!==e||(0,_log.errLog)("vxe.error.reqComp",["vxe-modal"]),l||"drawer"!==e||(0,_log.errLog)("vxe.error.reqComp",["vxe-drawer"]),o||(0,_log.errLog)("vxe.error.reqComp",["vxe-button"]),s||(0,_log.errLog)("vxe.error.reqComp",["vxe-input"]),i||(0,_log.errLog)("vxe.error.reqComp",["vxe-radio-group"])})},render(e){var t=this.$xeTable.computeCustomOpts;return(["modal","drawer","popup"].includes(""+t.mode)?renderPopupPanel:renderSimplePanel)(e,this)},methods:{handleWrapperMouseenterEvent(e){var t=this.$xeTable,l=this.customStore;l.activeWrapper=!0,t.customOpenEvent(e)},handleWrapperMouseleaveEvent(e){let t=this.$xeTable,l=this.customStore;l.activeWrapper=!1,setTimeout(()=>{l.activeBtn||l.activeWrapper||t.customCloseEvent(e)},300)},getStoreData(){return{}},confirmCustomEvent({$event:e}){var t=this.$xeTable;t.isCustomStatus=!0,t.saveCustom(),t.closeCustom(),t.emitCustomEvent("confirm",e)},cancelCloseEvent({$event:e}){var t=this.$xeTable;t.closeCustom(),t.emitCustomEvent("close",e)},cancelCustomEvent({$event:e}){var t=this.$xeTable;t.cancelCustom(),t.closeCustom(),t.emitCustomEvent("cancel",e)},handleResetCustomEvent(e){var t=this.$xeTable;t.resetCustom(!0),t.closeCustom(),t.emitCustomEvent("reset",e)},resetCustomEvent(t){_ui.VxeUI.modal?_ui.VxeUI.modal.confirm({content:getI18n("vxe.custom.cstmConfirmRestore"),className:"vxe-table--ignore-clear",escClosable:!0}).then(e=>{"confirm"===e&&this.handleResetCustomEvent(t)}):this.handleResetCustomEvent(t)},resetPopupCustomEvent(t){_ui.VxeUI.modal?_ui.VxeUI.modal.confirm({content:getI18n("vxe.custom.cstmConfirmRestore"),className:"vxe-table--ignore-clear",escClosable:!0}).then(e=>{"confirm"===e&&this.resetCustomEvent(t)}):this.resetCustomEvent(t)},handleOptionCheck(t){var e=this.$xeTable.customColumnList,e=_xeUtils.default.findTree(e,e=>e===t);e&&e.parent&&(e=e.parent,e.children)&&e.children.length&&(e.visible=e.children.every(e=>e.visible),e.halfVisible=!e.visible&&e.children.some(e=>e.visible||e.halfVisible),this.handleOptionCheck(e))},changeCheckboxOption(e){var t=this.$xeTable,l=t,o=t.computeCustomOpts;let s=!e.renderVisible;o.immediate?(_xeUtils.default.eachTree([e],e=>{e.visible=s,e.renderVisible=s,e.halfVisible=!1}),l.isCustomStatus=!0,t.handleCustom(),t.saveCustomStore("update:visible")):_xeUtils.default.eachTree([e],e=>{e.renderVisible=s,e.halfVisible=!1}),this.handleOptionCheck(e),t.checkCustomStatus()},changeColumnWidth(e){var t=this.$xeTable,l=t;t.computeCustomOpts.immediate&&e.renderResizeWidth!==e.renderWidth&&(e.resizeWidth=e.renderResizeWidth,e.renderWidth=e.renderResizeWidth,l.isCustomStatus=!0,t.handleCustom(),t.saveCustomStore("update:width"))},changeFixedOption(e,t){var l=this.$xeTable,o=l,s=l.computeIsMaxFixedColumn;l.computeCustomOpts.immediate?(e.renderFixed===t?_xeUtils.default.eachTree([e],e=>{e.fixed="",e.renderFixed=""}):s&&!e.renderFixed||_xeUtils.default.eachTree([e],e=>{e.fixed=t,e.renderFixed=t}),o.isCustomStatus=!0,l.handleCustom(),l.saveCustomStore("update:fixed")):e.renderFixed===t?_xeUtils.default.eachTree([e],e=>{e.renderFixed=""}):s&&!e.renderFixed||_xeUtils.default.eachTree([e],e=>{e.renderFixed=t})},allOptionEvent(){this.$xeTable.toggleCustomAllCheckbox()},sortMousedownEvent(e){var t=this.$xeTable,e=e.currentTarget.parentElement.parentElement.parentElement,l=e.getAttribute("colid"),t=t.getColumnById(l);e.draggable=!0,this.dragCol=t,(0,_dom.addClass)(e,"active--drag-origin")},sortMouseupEvent(e){e=e.currentTarget.parentElement.parentElement.parentElement;hideDropTip(this),e.draggable=!1,(this.dragCol=null,_dom.removeClass)(e,"active--drag-origin")},sortDragstartEvent(e){e.dataTransfer&&e.dataTransfer.setDragImage((0,_dom.getTpImg)(),0,0)},sortDragendEvent(d){let m=this.$xeTable;var e=m;let u=m;var t=m;let{dragCol:l,prevDragPos:p,prevDragCol:o,prevDragToChild:v}=this,x=e.mouseConfig,g=u.customColumnList,h=t.collectColumn,b=m.computeCustomOpts.immediate;e=d.currentTarget;let{isCrossDrag:C,isSelfToChildDrag:E,isToChildDrag:T,dragEndMethod:s}=m.computeColumnDragOpts,f="bottom"===p?1:0;if(o&&l&&o!==l){let n=l,c=o;Promise.resolve(!s||s({oldColumn:n,newColumn:c,dragColumn:n,dragPos:p,dragToChild:!!v,offsetIndex:f})).then(s=>{if(s){let e=-1,t=-1,l={},o=(_xeUtils.default.eachTree([n],e=>{l[e.id]=e}),!1);if(b){if(n.parentId&&c.parentId){if(!C)return;if(l[c.id]&&(o=!0,!C||!E))return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.message({status:"error",content:getI18n("vxe.error.treeDragChild")}))}else if(n.parentId){if(!C)return}else if(c.parentId){if(!C)return;if(l[c.id]&&(o=!0,!C||!E))return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.message({status:"error",content:getI18n("vxe.error.treeDragChild")}))}var i,r,a,s=_xeUtils.default.findTree(h,e=>e.id===n.id),s=(o&&C&&E?s&&({items:i,index:a}=s,(r=n.children||[]).forEach(e=>{e.parentId=n.parentId}),i.splice(a,1,...r),n.children=[]):s&&({items:i,index:a,parent:r}=s,i.splice(a,1),r||(e=a)),_xeUtils.default.findTree(h,e=>e.id===c.id));s&&({items:i,index:r,parent:a}=s,C&&T&&v?(n.parentId=c.id,c.children=(c.children||[]).concat([n])):(n.parentId=c.parentId,i.splice(r+f,0,n)),a||(t=r)),_xeUtils.default.eachTree(h,(e,t,l,o,s)=>{s||(e.renderSortNumber=t+1)})}else e=_xeUtils.default.findIndexOf(g,e=>e.id===n.id),g.splice(e,1),t=_xeUtils.default.findIndexOf(g,e=>e.id===c.id),g.splice(t+f,0,n);u.isDragColMove=!0,x&&(m.clearSelected&&m.clearSelected(),m.clearCellAreas)&&(m.clearCellAreas(),m.clearCopyCellArea()),m.dispatchEvent("column-dragend",{oldColumn:n,newColumn:c,dragColumn:n,dragPos:p,offsetIndex:f,_index:{newIndex:t,oldIndex:e}},d),b&&(u.customColumnList=h.slice(0),m.handleColDragSwapColumn())}}).catch(()=>{})}hideDropTip(this),this.dragCol.value=null,e.draggable=!1,e.removeAttribute("drag-pos"),(0,_dom.removeClass)(e,"active--drag-target"),(0,_dom.removeClass)(e,"active--drag-origin")},sortDragoverEvent(e){var t=this.$xeTable,l=this.dragCol,o=t.computeCustomOpts.immediate,{isCrossDrag:s,isToChildDrag:i}=t.computeColumnDragOpts,r=e.currentTarget,a=(0,_dom.hasControlKey)(e),n=r.getAttribute("colid"),t=t.getColumnById(n);t&&(s||1===t.level)&&(e.preventDefault(),n=e.clientY-r.getBoundingClientRect().y<r.clientHeight/2?"top":"bottom",l&&l.id===t.id||!s&&1<t.level||!o&&1<t.level||t.renderFixed?showDropTip(this,e,r,!1,n):(this.prevDragToChild=!!(s&&i&&a&&o),this.prevDragCol=t,this.prevDragPos=n,showDropTip(this,e,r,!0,n)))}}};