Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_util=require("./util"),_dom=require("../../ui/src/dom"),_vn=require("../../ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let{getI18n,renderer,renderEmptyElement}=_ui.VxeUI,renderType="body",isVMScrollProcess=e=>{var l=e.delayHover,{lastScrollTime:e,isDragResize:t}=e;return!!(t||e&&Date.now()<e+l)};function renderLine(e,l,t,r,o){var{row:a,column:i}=r,s=l.afterFullData,d=l.treeConfig,n=l.computeTreeOpts,{slots:i,treeNode:c}=i,p=l.fullAllDataRowIdData;if(i&&i.line)return l.callSlot(i.line,r,e);i=p[t];let u=0,g=null;return i&&(u=i.level,g=i.items[i.treeIndex-1]),d&&c&&(n.showLine||n.line)?[e("div",{key:"tl",class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:`${l.eqRow(s[0],a)?1:(0,_util.calcTreeLine)(r,g)}px`,bottom:`-${Math.floor(o/2)}px`,left:u*n.indent+(u?2-(0,_util.getOffsetSize)(l):0)+16+"px"}})])]:[]}function renderTdColumn(e,l,A,t,r,q,F,o,H,L,a,i,U,N,s){var d=l.$xeGrid,{columnKey:V,resizable:n,showOverflow:c,border:W,height:p,treeConfig:X,cellClassName:j,cellStyle:G,align:P,spanMethod:Y,mouseConfig:K,editConfig:J,editRules:u,tooltipConfig:g,padding:x}=l,{tableData:Q,dragRow:Z,overflowX:ee,currentColumn:le,scrollXLoad:te,scrollYLoad:re,mergeBodyFlag:oe,calcCellHeightFlag:m,resizeHeightFlag:v,resizeWidthFlag:ae,editStore:ie,isAllOverflow:se,validErrorMaps:w}=l,{fullAllDataRowIdData:de,fullColumnIdData:f,mergeBodyCellMaps:ne,visibleColumn:ce,afterFullData:pe,mergeBodyList:ue,scrollXStore:ge,scrollYStore:xe}=l,h=l.computeCellOpts,y=l.computeValidOpts,me=l.computeCheckboxOpts,ve=l.computeEditOpts,b=l.computeTooltipOpts,we=l.computeVirtualXOpts,fe=l.computeVirtualYOpts,{isAllColumnDrag:he,isAllRowDrag:ye}=l.resizableOpts,C=l.computeRowOpts,_=l.computeRowDragOpts,be=l.computeDefaultRowHeight,m=m?h.height||C.height:0,{disabledMethod:R,isCrossDrag:Ce,isPeerDrag:_e}=_,Re=l.computeColumnOpts,Ee=l.computeMouseOpts,Se=l.computeCellOffsetWidth,De=l.computeAreaOpts.selectCellToRow,{type:Oe,cellRender:$e,editRender:Ie,align:Te,showOverflow:ke,className:Be,treeNode:Me,rowResize:ze,padding:E,verticalAlign:S,slots:Ae}=i,D=h.verticalAlign,ie=ie.actived,qe=de[t]||{},O=i.id,f=f[O]||{},$=Ie||$e,$=$?renderer.get($.name):null,Fe=$?$.tableCellClassName||$.cellClassName:null,He=$?$.tableCellStyle||$.cellStyle:"";let Le=b.showAll;var Ue=f.index,b=f._index,f=(0,_utils.isEnableConf)(Ie),v=v?qe.resizeHeight:0;let I=r?i.fixed!==r:i.fixed&&ee;ee=_xeUtils.default.eqNull(E)?null===x?h.padding:x:E,x=_xeUtils.default.eqNull(ke)?c:ke,E="ellipsis"===x;let T="title"===x,k=!0===x||"tooltip"===x;c=se||T||k||E,ke=_xeUtils.default.isBoolean(i.resizable)?i.resizable:Re.resizable||n,x=!!m,n=0<v;let Ne;m={},v=Te||($?$.tableCellAlign:"")||P,Te=_xeUtils.default.eqNull(S)?D:S,$=w[t+":"+O],P=u&&y.showMessage&&("default"===y.message?p||1<Q.length:"inline"===y.message),D={colid:O};let B={$table:l,$grid:d,isEdit:!1,seq:A,rowid:t,row:o,rowIndex:H,$rowIndex:L,_rowIndex:a,column:i,columnIndex:Ue,$columnIndex:U,_columnIndex:b,fixed:r,type:renderType,isHidden:!!I,level:F,visibleData:pe,data:Q,items:s},M=!1,Ve=!1,z=((M=C.drag?"row"===_.trigger||i.dragSort&&"cell"===_.trigger:M)&&(Ve=!(!R||!R(B))),(T||k||Le||g)&&(m.mouseenter=e=>{isVMScrollProcess(l)||(T?(0,_dom.updateCellTitle)(e.currentTarget,i):(k||Le)&&l.triggerBodyTooltipEvent(e,B),l.dispatchEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},B),e))}),(k||Le||g)&&(m.mouseleave=e=>{isVMScrollProcess(l)||((k||Le)&&l.handleTargetLeaveEvent(e),l.dispatchEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},B),e))}),(M||me.range||K)&&(m.mousedown=e=>{l.triggerCellMousedownEvent(e,B)}),M&&(m.mouseup=l.triggerCellMouseupEvent),m.click=e=>{l.triggerCellClickEvent(e,B)},!(m.dblclick=e=>{l.triggerCellDblclickEvent(e,B)})),We=1;if(oe&&ue.length){S=ne[a+":"+b];if(S){var{rowspan:w,colspan:u}=S;if(!w||!u)return null;1<w&&(z=!0,We=w,D.rowspan=w),1<u&&(z=!0,D.colspan=u)}}else if(Y){var{rowspan:p=1,colspan:d=1}=Y(B)||{};if(!p||!d)return null;1<p&&(z=!0,We=p,D.rowspan=p),1<d&&(z=!0,D.colspan=d)}!(I=I&&z&&(1<D.colspan||1<D.rowspan)?!1:I)&&J&&(Ie||$e)&&(ve.showStatus||ve.showUpdateStatus)&&(Ne=l.isUpdateByRow(o,i.field));A=re&&!c;let Xe=(0,_util.getCellRestHeight)(qe,h,C,be);H=U===N.length-1,L=!i.resizeWidth&&("auto"===i.minWidth||"auto"===i.width);let je=!1;z||Z&&(0,_util.getRowid)(l,Z)===t||(re&&!X&&!fe.immediate&&(a<xe.visibleStartIndex-xe.preloadSize||a>xe.visibleEndIndex+xe.preloadSize)||te&&!we.immediate&&!i.fixed&&(b<ge.visibleStartIndex-ge.preloadSize||b>ge.visibleEndIndex+ge.preloadSize))&&(je=!0),1<We&&(Q=pe[a+We-1])&&(s=de[(0,_util.getRowid)(l,Q)])&&(Xe+=s.oTop-qe.oTop+(0,_util.getCellRestHeight)(s,h,C,be));_={};if(c&&ae){let l=D.colspan||0;if(1<l)for(let e=1;e<l;e++){var Ge=ce[Ue+e];Ge&&(l+=Ge.renderWidth)}_.width=i.renderWidth-Se*l+"px"}re||c||x||n?_.height=Xe+"px":_.minHeight=Xe+"px";R=[];I&&se?R.push(e("div",{key:"tc",class:["vxe-cell",{"c--title":T,"c--tooltip":k,"c--ellipsis":E}],style:_})):(X&&R.push(...renderLine(e,l,t,B,Xe)),R.push(e("div",{key:"tc",class:["vxe-cell",{"c--title":T,"c--tooltip":k,"c--ellipsis":E}],style:_,attrs:{title:T?l.getCellLabel(o,i):null}},je?[]:[e("div",{attrs:{colid:O,rowid:t},class:"vxe-cell--wrapper"},i.renderCell(e,B))])),P&&$&&(g=$.rule,me=Ae?Ae.valid:null,oe=Object.assign(Object.assign(Object.assign({},B),$),{rule:$}),R.push(e("div",{key:"tcv",class:["vxe-cell--valid-error-tip",(0,_utils.getClass)(y.className,$)],style:g&&g.maxWidth?{width:g.maxWidth+"px"}:void 0},[e("div",{class:"vxe-cell--valid-error-wrapper vxe-cell--valid-error-theme-"+(y.theme||"normal")},[me?l.callSlot(me,oe,e):[e("span",{class:"vxe-cell--valid-error-msg"},$.content)]])]))));let Pe=!1;return K&&Ee.area&&De&&((b||!0!==De)&&De!==i.field||(Pe=!0)),!I&&ke&&he&&R.push(e("div",{key:"tcc",class:["vxe-cell--col-resizable",{"is--line":!W||"none"===W}],on:{mousedown:e=>l.handleColResizeMousedownEvent(e,r,B),dblclick:e=>l.handleColResizeDblclickEvent(e,B)}})),(ze||ye)&&C.resizable&&R.push(e("div",{key:"tcr",class:"vxe-cell--row-resizable",on:{mousedown:e=>l.handleRowResizeMousedownEvent(e,B),dblclick:e=>l.handleRowResizeDblclickEvent(e,B)}})),e("td",{class:["vxe-body--column",O,Te?"col--vertical-"+Te:"",v?"col--"+v:"",Oe?"col--"+Oe:"",{"col--last":H,"col--tree-node":Me,"col--edit":f,"col--ellipsis":c,"col--cs-height":x,"col--rs-height":n,"col--to-row":Pe,"col--auto-height":A,"fixed--width":!L,"fixed--hidden":I,"is--padding":ee,"is--progress":I&&se||je,"is--drag-cell":M&&(Ce||_e||!F),"is--drag-disabled":Ve,"col--dirty":Ne,"col--active":J&&f&&ie.row===o&&(ie.column===i||"row"===ve.mode),"col--valid-error":!!$,"col--current":le===i},(0,_utils.getClass)(Fe,B),(0,_utils.getClass)(Be,B),(0,_utils.getClass)(j,B)],key:V||te||re||Re.useKey||C.useKey||Re.drag?i.id:U,attrs:D,style:Object.assign({},_xeUtils.default.isFunction(He)?He(B):He,_xeUtils.default.isFunction(G)?G(B):G),on:m},q&&I?[]:R)}function renderRows(v,w,f,h,y,b){let C=w.$parent;var e=C,l=C,t=C;let _=C.$xeGrid,{stripe:R,rowKey:E,highlightHoverRow:S,rowClassName:D,rowStyle:O,editConfig:$,treeConfig:I}=e,{hasFixedColumn:T,treeExpandedFlag:k,isColLoading:B,scrollXLoad:M,scrollYLoad:z,isAllOverflow:A,rowExpandedFlag:q,expandColumn:F,selectRadioRow:H,pendingRowFlag:L,isDragColMove:U,rowExpandHeightFlag:Y,isRowGroupStatus:N}=l,{fullAllDataRowIdData:K,fullColumnIdData:J,treeExpandedMaps:Q,pendingRowMaps:Z,rowExpandedMaps:ee}=t,le=C.computeCheckboxOpts,te=C.computeRadioOpts,V=C.computeTreeOpts,W=C.computeEditOpts,X=C.computeRowOpts,j=C.computeColumnOpts,re=C.computeColumnDragOpts,{transform:G,seqMode:oe}=V,ae=V.children||V.childrenField,P=[],ie=(0,_util.createHandleGetRowId)(C).handleGetRowId,se=I||N;return y.forEach((r,o)=>{var a={};let i=ie(r);var s=K[i]||{};let d=o,n=0,c=-1,p=-1;var u=N&&r.isAggregate,g=((X.isHover||S)&&(a.mouseenter=e=>{isVMScrollProcess(C)||C.triggerHoverEvent(e,{row:r,rowIndex:d})},a.mouseleave=()=>{isVMScrollProcess(C)||C.clearHoverRow()}),s&&(n=s.level,c=u||I&&G&&"increasing"===oe?s._index+1:s.seq,d=s.index,p=s._index),{$table:C,seq:c,rowid:i,fixed:f,type:renderType,level:n,row:r,rowIndex:d,$rowIndex:o,_rowIndex:p}),x=F&&!!q&&!!ee[i];let e=!1,l=[],t=!1;$&&(t=C.isInsertByRow(r)),!I||z||G||(l=r[ae],e=!!k&&l&&0<l.length&&!!Q[i]),!X.drag||N||I&&!G||(a.dragstart=C.handleRowDragDragstartEvent,a.dragend=C.handleRowDragDragendEvent,a.dragover=C.handleRowDragDragoverEvent);var u=["vxe-body--row",se?"row--level-"+n:"",{"row--stripe":R&&(p+1)%2==0,"is--new":t,"is--expand-row":x,"is--expand-tree":e,"row--new":t&&(W.showStatus||W.showInsertStatus),"row--radio":te.highlight&&H===r,"row--checked":le.highlight&&C.isCheckedByCheckboxRow(r),"row--pending":!!L&&!!Z[i],"row--group":u},D?_xeUtils.default.isFunction(D)?D(g):D:""],m=b.map((e,l)=>renderTdColumn(v,C,c,i,f,h,n,r,d,o,p,e,l,b,y));if(P.push(!B&&j.drag&&re.animation?v("transition-group",{props:{tag:"tr",name:"vxe-header--col-list"+(U?"":"-disabled")},class:u,attrs:{rowid:i},style:O?_xeUtils.default.isFunction(O)?O(g):O:void 0,key:E||M||z||X.useKey||X.drag||j.drag||N||I?i:o,nativeOn:a},m):v("tr",{class:u,attrs:{rowid:i},style:O?_xeUtils.default.isFunction(O)?O(g):O:void 0,key:E||M||z||X.useKey||X.drag||j.drag||N||I?i:o,on:a},m)),x){var{height:u,padding:g,mode:a}=C.computeExpandOpts;if("fixed"===a)P.push(v("tr",{class:"vxe-body--row-expanded-place",key:"expand_"+i,attrs:{rowid:i}},[v("td",{class:"vxe-body--row-expanded-place-column",attrs:{colspan:b.length},style:{height:`${Y?s.expandHeight||u:0}px`}})]));else{m={},x=(u&&(m.height=u+"px"),I&&(m.paddingLeft=n*V.indent+30+"px"),F||{}).showOverflow,a=F.id,s=J[a]||{},a=_xeUtils.default.isUndefined(x)||_xeUtils.default.isNull(x)?A:x;let e=-1,l=-1,t=-1;s&&(e=s.index,l=s.$index,t=s._index);x={$grid:_,$table:C,seq:c,column:F,columnIndex:e,$columnIndex:l,_columnIndex:t,fixed:f,type:renderType,level:n,row:r,rowid:i,rowIndex:d,$rowIndex:o,_rowIndex:p,isHidden:!1,isEdit:!1,visibleData:[],data:[],items:[]};P.push(v("tr",{class:["vxe-body--expanded-row",{"is--padding":g}],key:"expand_"+i},[v("td",{class:["vxe-body--expanded-column",{"fixed--hidden":f&&!T,"col--ellipsis":a}],attrs:{colspan:b.length}},[v("div",{class:["vxe-body--expanded-cell",{"is--ellipsis":u}],style:m},[F.renderData(v,x)])])]))}}e&&P.push(...renderRows(v,w,f,h,l,b))}),P}var _default=exports.default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,fixedType:{type:String,default:""}},mounted(){var e=this,l=e.fixedType,t=e.$parent.elemStore,l=`${l||"main"}-body-`;t[l+"wrapper"]=e.$refs.refElem,t[l+"scroll"]=e.$refs.refBodyScroll,t[l+"table"]=e.$refs.refBodyTable,t[l+"colgroup"]=e.$refs.refBodyColgroup,t[l+"list"]=e.$refs.refBodyTBody,t[l+"xSpace"]=e.$refs.refBodyXSpace,t[l+"ySpace"]=e.$refs.refBodyYSpace,t[l+"emptyBlock"]=e.$refs.refBodyEmptyBlock},destroyed(){var e=this.fixedType,l=this.$parent.elemStore,e=`${e||"main"}-body-`;l[e+"wrapper"]=null,l[e+"scroll"]=null,l[e+"table"]=null,l[e+"colgroup"]=null,l[e+"list"]=null,l[e+"xSpace"]=null,l[e+"ySpace"]=null,l[e+"emptyBlock"]=null},render(t){let l=this.$parent;var e=l,r=l,o=l,a=l.$xeGrid,{xID:i,$scopedSlots:s}=l;let{fixedColumn:d,fixedType:n,tableColumn:c}=this;var{spanMethod:p,footerSpanMethod:u,mouseConfig:g}=e,{isGroup:r,tableData:x,isRowLoading:m,isColLoading:v,overflowX:w,scrollXLoad:f,scrollYLoad:h,isAllOverflow:y,isDragRowMove:b,expandColumn:C,dragRow:_,dragCol:R}=r,{visibleColumn:o,fullAllDataRowIdData:E,fullColumnIdData:S}=o,D=l.computeRowOpts,O=l.computeEmptyOpts,$=l.computeMouseOpts,I=l.computeRowDragOpts,T=l.computeExpandOpts;let k=x,B=c,M=!1;!(f||h||y)||C&&"fixed"!==T.mode||p||u||(M=!0),v||!n&&w||(B=o),n&&M&&(B=d||[]),h&&_&&2<k.length&&(x=E[(0,_util.getRowid)(l,_)])&&(y=x._index,C=k[0],T=k[k.length-1],p=E[(0,_util.getRowid)(l,C)],u=E[(0,_util.getRowid)(l,T)],p)&&u&&(w=p._index,o=u._index,y<w?k=[_].concat(k):o<y&&(k=k.concat([_]))),n||r||f&&R&&2<B.length&&(h=S[R.id])&&(x=h._index,C=B[0],E=B[B.length-1],T=S[C.id],p=S[E.id],T)&&p&&(u=T._index,w=p._index,x<u?B=[R].concat(B):w<x&&(B=B.concat([R])));let z;return z=s.empty?s.empty.call(this,{$table:l,$grid:a}):(y=(o=O.name?renderer.get(O.name):null)?o.renderTableEmpty||o.renderTableEmptyView||o.renderEmpty:null)?(0,_vn.getSlotVNs)(y.call(this,t,O,{$table:l})):e.emptyText||getI18n("vxe.table.emptyText"),t("div",{ref:"refElem",class:["vxe-table--body-wrapper",n?`fixed-${n}--wrapper`:"body--wrapper"],attrs:{xid:i}},[t("div",{ref:"refBodyScroll",class:"vxe-table--body-inner-wrapper",on:{scroll(e){l.triggerBodyScrollEvent(e,n)}}},[n?renderEmptyElement(l):t("div",{ref:"refBodyXSpace",class:"vxe-body--x-space"}),t("div",{ref:"refBodyYSpace",class:"vxe-body--y-space"}),t("table",{ref:"refBodyTable",class:"vxe-table--body",attrs:{xid:i,cellspacing:0,cellpadding:0,border:0,xvm:M?"1":null}},[t("colgroup",{ref:"refBodyColgroup"},B.map((e,l)=>t("col",{attrs:{name:e.id},key:l,style:{width:e.renderWidth+"px"}}))),!m&&!v&&D.drag&&I.animation?t("transition-group",{ref:"refBodyTBody",props:{tag:"tbody",name:"vxe-body--row-list"+(b?"":"-disabled")}},renderRows(t,this,n,M,k,B)):t("tbody",{ref:"refBodyTBody"},renderRows(t,this,n,M,k,B))]),t("div",{class:"vxe-table--checkbox-range"}),g&&$.area?t("div",{class:"vxe-table--cell-area"},[t("span",{class:"vxe-table--cell-main-area"},$.extension?[t("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown(e){l.triggerCellAreaExtendMousedownEvent&&l.triggerCellAreaExtendMousedownEvent(e,{$table:l,fixed:n,type:renderType})}}})]:null),t("span",{class:"vxe-table--cell-copy-area"}),t("span",{class:"vxe-table--cell-extend-area"}),t("span",{class:"vxe-table--cell-multi-area"}),t("span",{class:"vxe-table--cell-active-area"}),t("span",{class:"vxe-table--cell-row-status-area"})]):renderEmptyElement(l),n?renderEmptyElement(l):t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},z)])])])}};