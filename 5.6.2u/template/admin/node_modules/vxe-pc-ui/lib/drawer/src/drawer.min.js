Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.allActiveDrawers=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_vn=require("../../ui/src/vn"),_button=_interopRequireDefault(require("../../button/src/button")),_index=_interopRequireDefault(require("../../loading/index"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}var allActiveDrawers=exports.allActiveDrawers=[],_default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeDrawer",mixins:[_ui.globalMixins.sizeMixin,_ui.globalMixins.permissionMixin],props:{value:Boolean,id:String,title:String,loading:{type:Boolean,default:null},className:String,position:{type:[String,Object],default:function(){return(0,_ui.getConfig)().drawer.position}},lockView:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.lockView}},lockScroll:Boolean,mask:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.mask}},maskClosable:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.maskClosable}},escClosable:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.escClosable}},cancelClosable:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.cancelClosable}},confirmClosable:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.confirmClosable}},showHeader:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.showHeader}},showFooter:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.showFooter}},showClose:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.showClose}},content:[Number,String],showCancelButton:{type:Boolean,default:null},cancelButtonText:{type:String,default:function(){return(0,_ui.getConfig)().drawer.cancelButtonText}},showConfirmButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.showConfirmButton}},confirmButtonText:{type:String,default:function(){return(0,_ui.getConfig)().drawer.confirmButtonText}},destroyOnClose:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.destroyOnClose}},showTitleOverflow:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.showTitleOverflow}},width:[Number,String],height:[Number,String],resize:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.resize}},zIndex:Number,transfer:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.transfer}},padding:{type:Boolean,default:function(){return(0,_ui.getConfig)().drawer.padding}},size:{type:String,default:function(){return(0,_ui.getConfig)().drawer.size||(0,_ui.getConfig)().size}},beforeHideMethod:{type:Function,default:function(){return(0,_ui.getConfig)().drawer.beforeHideMethod}},slots:Object},inject:{$xeModal:{default:null},$xeParentDrawer:{from:"$xeDrawer",default:null},$xeTable:{default:null},$xeForm:{default:null}},provide:function(){return{$xeDrawer:this}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{initialized:!1,visible:!1,contentVisible:!1,drawerZIndex:0,resizeFlag:1}}},computed:Object.assign(Object.assign({},{}),{computeBtnTransfer:function(){var e=this,t=e.$xeTable,r=e.$xeModal,n=e.$xeParentDrawer,i=e.$xeForm,e=e.transfer;if(null===e){var o=(0,_ui.getConfig)().select.transfer;if(_xeUtils.default.isBoolean(o))return o;if(t||r||n||i)return!0}return e},computeDragType:function(){switch(this.position){case"top":return"sb";case"bottom":return"st";case"left":return"wr"}return"wl"}}),methods:{dispatchEvent:function(e,t,r){this.$emit(e,(0,_ui.createEvent)(r,{$drawer:this},t))},emitModel:function(e){var t=this._events;this.$emit("input",e),t&&t.modelValue?this.$emit("modelValue",e):this.$emit("model-value",e)},callSlot:function(e,t,r){var n=this.$scopedSlots;return e&&(_xeUtils.default.isString(e)&&(e=n[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e.call(this,t,r)):[]},open:function(){return this.openDrawer()},close:function(){return this.closeDrawer("close")},getBox:function(){return this.$refs.refDrawerBox},recalculate:function(){var e=this.width,t=this.height,r=this.getBox();return r&&(r.style.width=(0,_dom.toCssUnit)(e),r.style.height=(0,_dom.toCssUnit)(t)),this.$nextTick()},updateZindex:function(){var e=this.reactData,t=this.zIndex,r=e.drawerZIndex;t?e.drawerZIndex=t:r<(0,_utils.getLastZIndex)()&&(e.drawerZIndex=(0,_utils.nextZIndex)())},closeDrawer:function(e){var t=this,r=t.reactData,n=t.beforeHideMethod,i=r.visible,o={type:e};return i&&Promise.resolve(n?n(o):null).then(function(e){_xeUtils.default.isError(e)||(r.contentVisible=!1,_xeUtils.default.remove(allActiveDrawers,function(e){return e===t}),t.dispatchEvent("before-hide",o,null),setTimeout(function(){r.visible=!1,t.emitModel(!1),t.dispatchEvent("hide",o,null)},200))}).catch(function(e){return e}),t.$nextTick()},closeEvent:function(e){var t="close";this.dispatchEvent(t,{type:t},e),this.closeDrawer(t)},confirmEvent:function(e){var t=this.confirmClosable,r="confirm";this.dispatchEvent(r,{type:r},e),t&&this.closeDrawer(r)},cancelEvent:function(e){var t=this.cancelClosable,r="cancel";this.dispatchEvent(r,{type:r},e),t&&this.closeDrawer(r)},openDrawer:function(){var r=this,e=r.reactData,n=r.showFooter,t=e.initialized,i=e.visible,o=r.computeBtnTransfer;return t||(e.initialized=!0,o&&(t=r.$refs.refElem,document.body.appendChild(t))),i||(e.visible=!0,e.contentVisible=!1,r.updateZindex(),allActiveDrawers.push(r),setTimeout(function(){r.recalculate(),e.contentVisible=!0,r.$nextTick(function(){n&&(e=r.$refs.refConfirmBtn,t=r.$refs.refCancelBtn,e=e||t)&&e.focus();var e,t={type:""};r.emitModel(!0),r.dispatchEvent("show",t,null)})},10)),r.$nextTick()},selfClickEvent:function(e){var t=this.$refs.refElem;this.maskClosable&&e.target===t&&this.closeDrawer("mask")},handleGlobalKeydownEvent:function(e){var t,r=this;_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ESCAPE)&&(t=_xeUtils.default.max(allActiveDrawers,function(e){return e.reactData.drawerZIndex}))&&setTimeout(function(){t===r&&t.escClosable&&(r.dispatchEvent("close",{type:"exit"},e),r.closeDrawer("exit"))},10)},boxMousedownEvent:function(){var t=this.reactData.drawerZIndex;allActiveDrawers.some(function(e){return e.reactData.visible&&e.reactData.drawerZIndex>t})&&this.updateZindex()},dragEvent:function(e){var o=this,a=o.reactData,t=(e.preventDefault(),(0,_dom.getDomNode)()),l=t.visibleHeight,s=t.visibleWidth,u=e.target.getAttribute("type"),c=s,d=l,f=o.getBox(),p=f.clientWidth,v=f.clientHeight,w=e.clientX,h=e.clientY,m=f.offsetTop,g=f.offsetLeft,x={type:"resize"};document.onmousemove=function(e){var t,r,n,i;switch(e.preventDefault(),u){case"wl":n=(t=w-e.clientX)+p,0<g-t&&0<n&&(f.style.width="".concat(n<c?n:c,"px"));break;case"st":r=h-e.clientY,i=v+r,0<m-r&&0<i&&(f.style.height="".concat(i<d?i:d,"px"));break;case"wr":t=e.clientX-w,g+(n=t+p)+0<s&&0<n&&(f.style.width="".concat(n<c?n:c,"px"));break;case"sb":r=e.clientY-h,m+(i=r+v)+0<l&&0<i&&(f.style.height="".concat(i<d?i:d,"px"))}f.className=f.className.replace(/\s?is--drag/,"")+" is--drag",o.dispatchEvent("resize",x,e),a.resizeFlag++},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null,a.resizeFlag++,setTimeout(function(){f.className=f.className.replace(/\s?is--drag/,"")},50)}},renderTitles:function(e){var t=this,r=t.$scopedSlots,n=t.slots,n=void 0===n?{}:n,i=t.showClose,o=t.title,a=r.title||n.title,r=r.corner||n.corner;return[e("div",{class:"vxe-drawer--header-title"},a?t.callSlot(a,{$drawer:t},e):o?(0,_utils.getFuncText)(o):(0,_ui.getI18n)("vxe.alert.title")),e("div",{class:"vxe-drawer--header-right"},[r?e("div",{class:"vxe-drawer--corner-wrapper"},t.callSlot(r,{$drawer:t},e)):(0,_ui.renderEmptyElement)(t),i?e("div",{class:["vxe-drawer--close-btn","trigger--btn"],attrs:{title:(0,_ui.getI18n)("vxe.drawer.close")},on:{click:t.closeEvent}},[e("i",{class:(0,_ui.getIcon)().DRAWER_CLOSE})]):(0,_ui.renderEmptyElement)(t)])]},renderHeader:function(e){var t=this,r=t.$scopedSlots,n=t.slots,r=r.header||(void 0===n?{}:n).header;return t.showHeader?e("div",{class:["vxe-drawer--header",{"is--ellipsis":t.showTitleOverflow}]},r?t.callSlot(r,{$drawer:t},e):t.renderTitles(e)):(0,_ui.renderEmptyElement)(t)},renderBody:function(e){var t=this,r=t,n=t.$scopedSlots,i=r.slots,i=void 0===i?{}:i,o=r.content,a=n.default||i.default,l=n.left||i.left,n=n.right||i.right;return e("div",{class:"vxe-drawer--body"},[l?e("div",{class:"vxe-drawer--body-left"},t.callSlot(l,{$drawer:t},e)):(0,_ui.renderEmptyElement)(t),e("div",{class:"vxe-drawer--body-default"},[e("div",{class:"vxe-drawer--content"},a?t.callSlot(a,{$drawer:t},e):(0,_utils.getFuncText)(o))]),n?e("div",{class:"vxe-drawer--body-right"},t.callSlot(n,{$drawer:t},e)):(0,_ui.renderEmptyElement)(t),e(_index.default,{class:"vxe-drawer--loading",props:{value:r.loading}})])},renderDefaultFooter:function(e){var t=this,r=t,n=t.$scopedSlots,i=r.slots,i=void 0===i?{}:i,o=r.showConfirmButton,a=r.loading,l=n.leftfoot||i.leftfoot,n=n.rightfoot||i.rightfoot,i=[];return r.showCancelButton&&i.push(e(_button.default,{key:1,ref:"refCancelBtn",props:{content:r.cancelButtonText||(0,_ui.getI18n)("vxe.button.cancel")},on:{click:t.cancelEvent}})),o&&i.push(e(_button.default,{key:2,ref:"refConfirmBtn",props:{status:"primary",loading:a,content:r.confirmButtonText||(0,_ui.getI18n)("vxe.button.confirm")},on:{click:t.confirmEvent}})),e("div",{class:"vxe-drawer--footer-wrapper"},[e("div",{class:"vxe-drawer--footer-left"},l?t.callSlot(l,{$drawer:t},e):[]),e("div",{class:"vxe-drawer--footer-right"},n?t.callSlot(n,{$drawer:t},e):i)])},renderFooter:function(e){var t=this,r=t.$scopedSlots,n=t.slots,r=r.footer||(void 0===n?{}:n).footer;return t.showFooter?e("div",{class:"vxe-drawer--footer"},r?t.callSlot(r,{$drawer:t},e):[t.renderDefaultFooter(e)]):(0,_ui.renderEmptyElement)(t)},renderVN:function(e){var t=this,r=t.$scopedSlots,n=t.reactData,i=t.slots,o=t.className,a=t.loading,l=t.lockScroll,s=t.padding,u=t.lockView,c=t.mask,d=t.resize,f=t.destroyOnClose,p=n.initialized,v=n.contentVisible,w=n.visible,r=r.aside||(void 0===i?{}:i).aside,i=t.computeSize,h=t.computeDragType;return e("div",{ref:"refElem",class:["vxe-drawer--wrapper","pos--".concat(t.position),o||"",_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(i),i),"is--padding",s),"lock--scroll",l),"lock--view",u),"is--mask",c),"is--visible",v),"is--active",w),"is--loading",a)],style:{zIndex:n.drawerZIndex},on:{click:t.selfClickEvent}},p?[e("div",{ref:"refDrawerBox",class:"vxe-drawer--box",on:{mousedown:t.boxMousedownEvent}},[r?e("div",{class:"vxe-drawer--aside"},t.callSlot(r,{$drawer:t},e)):(0,_ui.renderEmptyElement)(t),e("div",{class:"vxe-drawer--container"},!n.initialized||f&&!n.visible?[]:[t.renderHeader(e),t.renderBody(e),t.renderFooter(e),d?e("span",{class:"vxe-drawer--resize"},[e("span",{class:"".concat(h,"-resize"),attrs:{type:h},on:{mousedown:t.dragEvent}})]):(0,_ui.renderEmptyElement)(t)])])]:[])}},watch:{width:function(){this.recalculate()},height:function(){this.recalculate()},value:function(e){e?this.openDrawer():this.closeDrawer("model")}},mounted:function(){var e=this,t=e;e.$nextTick(function(){t.value&&e.openDrawer()}),t.escClosable&&_ui.globalEvents.on(e,"keydown",e.handleGlobalKeydownEvent)},beforeDestroy:function(){var e=this.$refs.refElem;e&&e.parentNode&&e.parentNode.removeChild(e),_ui.globalEvents.off(this,"keydown")},render:function(e){return this.renderVN(e)}});