Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_vn=require("../../ui/src/vn"),_log=require("../../ui/src/log"),_dom=require("../../ui/src/dom"),_util=require("./util"),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,o){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);o=o.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}function getUniqueKey(){return _xeUtils.default.uniqueId()}function handleTransferFiles(e){var t=[];return _xeUtils.default.arrayEach(e,function(e){e=e.getAsFile();e&&t.push(e)}),t}function showDropTip(e,t,o,i){var n=e.xID,a=e.reactData.showMorePopup,r=e.$refs.refElem,l=document.getElementById("refPopupElem".concat(n)),l=a?l:r;l&&(r=l.getBoundingClientRect(),l=e.$refs.refDragLineElem,e=document.getElementById("refModalDragLineElem".concat(n)),n=a?e:l)&&(a=o.getBoundingClientRect(),n.style.display="block",n.style.top="".concat(Math.max(1,a.y-r.y),"px"),n.style.left="".concat(Math.max(1,a.x-r.x),"px"),n.style.height="".concat(a.height,"px"),n.style.width="".concat(a.width-1,"px"),n.setAttribute("drag-pos",i))}function hideDropTip(e){var t=e.xID,e=e.$refs.refDragLineElem,t=document.getElementById("refModalDragLineElem".concat(t));e&&(e.style.display=""),t&&(t.style.display="")}var _default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeUpload",model:{prop:"value",event:"modelValue"},mixins:[_ui.globalMixins.sizeMixin],props:{value:[Array,String,Object],showList:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showList}},moreConfig:Object,readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},mode:{type:String,default:function(){return(0,_ui.getConfig)().upload.mode}},imageTypes:{type:Array,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().upload.imageTypes,!0)}},imageConfig:{type:Object,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().upload.imageConfig,!0)}},imageStyle:{type:Object,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().upload.imageStyle,!0)}},fileTypes:{type:Array,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().upload.fileTypes,!0)}},dragSort:Boolean,dragToUpload:{type:Boolean,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().upload.dragToUpload,!0)}},pasteToUpload:{type:Boolean,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().upload.pasteToUpload,!0)}},keyField:String,singleMode:Boolean,urlMode:Boolean,multiple:Boolean,limitSize:{type:[String,Number],default:function(){return(0,_ui.getConfig)().upload.limitSize}},showLimitSize:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showLimitSize}},limitSizeText:{type:[String,Number,Function],default:function(){return(0,_ui.getConfig)().upload.limitSizeText}},limitCount:{type:[String,Number],default:function(){return(0,_ui.getConfig)().upload.limitCount}},showLimitCount:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showLimitCount}},limitCountText:{type:[String,Number,Function],default:function(){return(0,_ui.getConfig)().upload.limitCountText}},nameField:{type:String,default:function(){return(0,_ui.getConfig)().upload.nameField}},typeField:{type:String,default:function(){return(0,_ui.getConfig)().upload.typeField}},urlField:{type:String,default:function(){return(0,_ui.getConfig)().upload.urlField}},sizeField:{type:String,default:function(){return(0,_ui.getConfig)().upload.sizeField}},showErrorStatus:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showErrorStatus}},showProgress:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showProgress}},progressText:{type:[String,Number,Function],default:function(){return(0,_ui.getConfig)().upload.progressText}},autoHiddenButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.autoHiddenButton}},showUploadButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showUploadButton}},buttonText:{type:[String,Number,Function],default:function(){return(0,_ui.getConfig)().upload.buttonText}},buttonIcon:{type:String,default:function(){return(0,_ui.getConfig)().upload.buttonIcon}},showButtonText:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showButtonText}},showButtonIcon:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showButtonIcon}},showRemoveButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showRemoveButton}},showDownloadButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showDownloadButton}},showPreview:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showPreview}},showTip:{type:Boolean,default:function(){return(0,_ui.getConfig)().upload.showTip}},tipText:[String,Number,Function],hintText:String,previewMethod:Function,uploadMethod:Function,beforeRemoveMethod:Function,removeMethod:Function,beforeDownloadMethod:Function,downloadMethod:Function,getUrlMethod:Function,getThumbnailUrlMethod:Function,size:{type:String,default:function(){return(0,_ui.getConfig)().upload.size||(0,_ui.getConfig)().size}}},inject:{$xeForm:{default:null},formItemInfo:{from:"xeFormItemInfo",default:null},$xeTable:{default:null}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{isDragUploadStatus:!1,showMorePopup:!1,isActivated:!1,fileList:[],fileCacheMaps:{},isDragMove:!1,dragIndex:-1,dragTipText:""},internalData:{imagePreviewTypes:["jpg","jpeg","png","gif"],prevDragIndex:-1}}},computed:Object.assign(Object.assign({},{}),{computeFormReadonly:function(){var e=this.$xeForm,t=this.readonly;return null===t?!!e&&e.readonly:t},computeIsDisabled:function(){var e=this.$xeForm,t=this.disabled;return null===t?!!e&&e.disabled:t},computeKeyField:function(){return this.keyField||"_X_KEY"},computeIsImage:function(){return"image"===this.mode},computeNameProp:function(){return this.nameField||"name"},computeTypeProp:function(){return this.typeField||"type"},computeUrlProp:function(){return this.urlField||"url"},computeSizeProp:function(){return this.sizeField||"size"},computeLimitMaxSize:function(){return 1024*_xeUtils.default.toNumber(this.limitSize)*1024},computeLimitMaxCount:function(){return this.multiple?_xeUtils.default.toNumber(this.limitCount):1},computeOverCount:function(){var e=this.reactData,t=this.multiple,e=e.fileList,o=this.computeLimitMaxCount;return t?!o||e.length>=o:1<=e.length},computeLimitSizeUnit:function(){var e=_xeUtils.default.toNumber(this.limitSize);return e?1048576<e?"".concat(e/1048576,"T"):1024<e?"".concat(e/1024,"G"):"".concat(e,"M"):""},computedShowTipText:function(){var e=this.showTip,t=this.tipText;return _xeUtils.default.isBoolean(e)||(e=(0,_ui.getConfig)().upload.showTip,_xeUtils.default.isBoolean(e))?e:!!t},computedDefTipText:function(){var e=this,t=e.limitSize,o=e.fileTypes,i=e.multiple,n=e.limitCount,e=e.tipText||e.hintText,a=this.computeIsImage,r=this.computeLimitSizeUnit;return _xeUtils.default.isString(e)?e:_xeUtils.default.isFunction(e)?"".concat(e({})):(e=[],a?(i&&n&&e.push((0,_ui.getI18n)("vxe.upload.imgCountHint",[n])),t&&r&&e.push((0,_ui.getI18n)("vxe.upload.imgSizeHint",[r]))):(o&&o.length&&e.push((0,_ui.getI18n)("vxe.upload.fileTypeHint",[o.join("/")])),t&&r&&e.push((0,_ui.getI18n)("vxe.upload.fileSizeHint",[r])),i&&n&&e.push((0,_ui.getI18n)("vxe.upload.fileCountHint",[n]))),e.join((0,_ui.getI18n)("vxe.base.comma")))},computeImageOpts:function(){return Object.assign({},this.imageConfig||this.imageStyle)},computeImgStyle:function(){var e=this.computeImageOpts,t=e.width,e=e.height,o={};return t&&(o.width=(0,_dom.toCssUnit)(t)),e&&(o.height=(0,_dom.toCssUnit)(e)),o},computeMoreOpts:function(){return Object.assign({showMoreButton:!0},this.moreConfig)}}),watch:{value:function(){this.updateFileList()}},methods:{dispatchEvent:function(e,t,o){this.$emit(e,(0,_ui.createEvent)(o,{$upload:this},t))},emitModel:function(e){this.$emit("modelValue",e)},choose:function(){return this.handleChoose(null)},getFieldKey:function(e){return e[this.computeKeyField]},updateFileList:function(){var n=this,e=n.reactData,t=n.value,o=n.multiple,i=n.computeFormReadonly,a=n.computeKeyField,r=n.computeNameProp,l=n.computeTypeProp,u=n.computeUrlProp,d=n.computeSizeProp,t=t?(t?_xeUtils.default.isArray(t)?t:[t]:[]).map(function(e){var t,o,i;return!e||_xeUtils.default.isString(e)?(t="".concat(e||""),i=((o=_xeUtils.default.parseUrl(e))?o.searchQuery[r]:"")||n.parseFileName(t),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty({},r,i),l,(o?o.searchQuery[l]:"")||n.parseFileType(i)),u,t),d,_xeUtils.default.toNumber(o?o.searchQuery[d]:0)||0),a,getUniqueKey())):(i=e[r]||"",e[r]=i,e[l]=e[l]||n.parseFileType(i),e[u]=e[u]||"",e[d]=e[d]||0,e[a]=e[a]||getUniqueKey(),e)}):[];e.fileList=i||o?t:t.slice(0,1)},parseFileName:function(e){return decodeURIComponent("".concat(e||"")).split("/").pop()||""},parseFileType:function(e){var t=e.lastIndexOf(".");return 0<t?e.substring(t+1).toLowerCase():""},handleChange:function(e){var t=this.singleMode,o=this.urlMode,i=this.computeUrlProp,n=this.computeNameProp,e=e?e.slice(0):[];o&&(e=e.map(function(e){var t=e[i];if(t&&!_xeUtils.default.parseUrl(t).searchQuery[n])return"".concat(t).concat(-1===t.indexOf("?")?"?":"&").concat(encodeURIComponent(e[n]||""));return t})),this.emitModel(t?e[0]||null:e)},getThumbnailFileUrl:function(e){var t=this.getThumbnailUrlMethod||(0,_ui.getConfig)().upload.getThumbnailUrlMethod;return t?t({$upload:this,option:e}):this.getFileUrl(e)},getFileUrl:function(e){var t=this.getUrlMethod||(0,_ui.getConfig)().upload.getUrlMethod,o=this.computeUrlProp;return t?t({$upload:this,option:e}):e[o]},handleDefaultFilePreview:function(t){var e=this,o=e.internalData,i=e.imageTypes,n=e.showDownloadButton,a=e.computeTypeProp,r=e.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;o.imagePreviewTypes.concat(i||[]).some(function(e){return"".concat(e).toLowerCase()==="".concat(t[a]).toLowerCase()})&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:[e.getFileUrl(t)],showDownloadButton:n,beforeDownloadMethod:r?function(){return r({$upload:e,option:t})}:void 0})},handlePreviewFileEvent:function(e,t){var o=this.previewMethod||(0,_ui.getConfig)().upload.previewMethod;this.showPreview&&(o?o({$upload:this,option:t}):this.handleDefaultFilePreview(t))},handlePreviewImageEvent:function(e,t,o){var i=this,n=i,a=i.reactData,r=n.showDownloadButton,l=a.fileList,u=n.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;n.showPreview&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:l.map(function(e){return i.getFileUrl(e)}),activeIndex:o,showDownloadButton:r,beforeDownloadMethod:u?function(e){e=e.index;return u({$upload:i,option:l[e]})}:void 0})},handleUploadResult:function(o,e){var i=this,t=i,n=i.reactData,a=t.showErrorStatus,r=i.getFieldKey(o),t=t.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod;return t?Promise.resolve(t({$upload:i,file:e,option:o,updateProgress:function(e){var t=n.fileCacheMaps[i.getFieldKey(o)];t&&(t.percent=Math.max(0,Math.min(99,_xeUtils.default.toNumber(e))))}})).then(function(e){var t=n.fileCacheMaps[r];t&&(t.percent=100),Object.assign(o,e),i.dispatchEvent("upload-success",{option:o,data:e},null)}).catch(function(e){var t=n.fileCacheMaps[r];t&&(t.status="error"),a?Object.assign(o,e):n.fileList=n.fileList.filter(function(e){return i.getFieldKey(e)!==r}),i.dispatchEvent("upload-error",{option:o,data:e},null)}).finally(function(){var e=n.fileCacheMaps[r];e&&(e.loading=!1)}):((t=n.fileCacheMaps[r])&&(t.loading=!1),Promise.resolve())},handleReUpload:function(e){var t=this,o=t.reactData,i=t.uploadMethod,n=t.urlMode,a=o.fileCacheMaps[t.getFieldKey(e)];(i||(0,_ui.getConfig)().upload.uploadMethod)&&a&&(i=a.file,a.loading=!0,a.status="",a.percent=0,t.handleUploadResult(e,i).then(function(){n&&t.handleChange(o.fileList)}))},uploadFile:function(e,i){var n=this,t=n.reactData,o=n.$xeForm,a=n.formItemInfo,r=n.multiple,l=n.urlMode,u=n.showLimitSize,d=n.limitSizeText,s=n.showLimitCount,p=n.limitCountText,c=t.fileList,m=n.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod,g=n.computeKeyField,f=n.computeNameProp,v=n.computeTypeProp,h=n.computeUrlProp,_=n.computeSizeProp,x=n.computeLimitMaxSize,y=n.computeLimitMaxCount,E=n.computeLimitSizeUnit,I=e;if(r&&y){if(s&&c.length>=y)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:p?"".concat(_xeUtils.default.isFunction(p)?p({maxCount:y}):p):(0,_ui.getI18n)("vxe.upload.overCountErr",[y])}));var w,D=I.length-(y-c.length);s&&0<D&&(w=I.slice(y-c.length),p?_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:"".concat(_xeUtils.default.isFunction(p)?p({maxCount:y}):p)}):_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",slots:{default:function(e,o){return o("div",{class:"vxe-upload--file-message-over-error"},[o("div",{},(0,_ui.getI18n)("vxe.upload.overCountExtraErr",[y,D])),o("div",{class:"vxe-upload--file-message-over-extra"},w.map(function(e,t){return o("div",{key:t,class:"vxe-upload--file-message-over-extra-item"},e.name)}))])}}})),I=I.slice(0,y-c.length)}if(u&&x)for(var U=0;U<e.length;U++)if(e[0].size>x)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:d?"".concat(_xeUtils.default.isFunction(d)?d({maxSize:x}):d):(0,_ui.getI18n)("vxe.upload.overSizeErr",[E])}));var b=Object.assign({},t.fileCacheMaps),T=r?c:[],C=[];I.forEach(function(e){var t=e.name,o=getUniqueKey(),t=_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty({},f,t),v,n.parseFileType(t)),_,e.size),h,URL.createObjectURL(e)),g,o),o=(m&&(b[o]={file:e,loading:!0,status:"",percent:0}),t);m&&C.push(n.handleUploadResult(o,e)),T.push(o),n.dispatchEvent("add",{option:o},i)}),t.fileList=T,t.fileCacheMaps=b,Promise.all(l?C:[]).then(function(){n.handleChange(T),o&&a&&o.triggerItemEvent(i,a.itemConfig.field,T)})},handleChoose:function(t){var o=this,e=o.multiple,i=o.imageTypes,n=o.fileTypes,a=o.computeIsDisabled,r=o.computeIsImage;return a?Promise.resolve({status:!1,files:[],file:null}):(0,_util.readLocalFile)({multiple:e,types:r?i:n}).then(function(e){return o.uploadFile(e.files,t),e})},clickEvent:function(e){this.handleChoose(e).catch(function(){})},handleRemoveEvent:function(e,t,o){var i=this,n=i.reactData,a=i.$xeForm,r=i.formItemInfo,n=n.fileList;n.splice(o,1),i.handleChange(n),a&&r&&a.triggerItemEvent(e,r.itemConfig.field,n),i.dispatchEvent("remove",{option:t},e)},removeFileEvent:function(t,o,i){var n=this,e=n,a=e.beforeRemoveMethod||(0,_ui.getConfig)().upload.beforeRemoveMethod,r=e.removeMethod||(0,_ui.getConfig)().upload.removeMethod;Promise.resolve(!a||a({$upload:n,option:o})).then(function(e){e?r?Promise.resolve(r({$upload:n,option:o})).then(function(){n.handleRemoveEvent(t,o,i)}).catch(function(e){return e}):n.handleRemoveEvent(t,o,i):n.dispatchEvent("remove-fail",{option:o},t)})},handleDownloadEvent:function(e,t){this.dispatchEvent("download",{option:t},e)},downloadFileEvent:function(t,o){var i=this,e=i,n=e.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod,a=e.downloadMethod||(0,_ui.getConfig)().upload.downloadMethod;Promise.resolve(!n||n({$upload:i,option:o})).then(function(e){e?a?Promise.resolve(a({$upload:i,option:o})).then(function(){i.handleDownloadEvent(t,o)}).catch(function(e){return e}):i.handleDownloadEvent(t,o):i.dispatchEvent("download-fail",{option:o},t)})},handleUploadDragleaveEvent:function(e){var t,o,i=this.reactData,n=e.currentTarget,a=e.clientX,e=e.clientY;n&&(t=(n=n.getBoundingClientRect()).x,o=n.y,a<t||t+n.width<a||e<o||o+n.height<e)&&(i.isDragUploadStatus=!1)},handleUploadDragoverEvent:function(e){var t=this.reactData,o=e.dataTransfer;o&&(o=o.items)&&o.length&&(e.preventDefault(),t.isDragUploadStatus=!0)},uploadTransferFileEvent:function(e,t){var o=this,i=o.internalData,n=o.imageTypes,a=o.fileTypes,i=i.imagePreviewTypes;if(o.computeIsImage){var r=i.concat(n&&n.length?n:[]);t=t.filter(function(e){var t="".concat(e.type.split("/")[1]||"").toLowerCase();return!!r.some(function(e){return"".concat(e).toLowerCase()===t})})}else if(a&&a.length){var l=[];if(t.forEach(function(e){var t=o.parseFileType(e.name);a.some(function(e){return"".concat(e).toLowerCase()===t})||l.push(t)}),l.length)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.message({content:(0,_ui.getI18n)("vxe.error.notType",[l.join(", ")]),status:"error"}))}t.length?o.uploadFile(t,e):_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.uploadTypeErr")})},handleUploadDropEvent:function(e){var t=this.reactData,o=e.dataTransfer;o&&(o=o.items)&&o.length&&(e.preventDefault(),(o=handleTransferFiles(o)).length)&&this.uploadTransferFileEvent(e,o),t.isDragUploadStatus=!1},handleMoreEvent:function(){var c=this,m=c,g=c.reactData,f=c.xID,v=c.computeFormReadonly,h=c.computeIsImage;_ui.VxeUI.modal&&_ui.VxeUI.modal.open({title:v?(0,_ui.getI18n)("vxe.upload.morePopup.readTitle"):(0,_ui.getI18n)("vxe.upload.morePopup.".concat(h?"imageTitle":"fileTitle")),width:660,height:500,escClosable:!0,showMaximize:!0,resize:!0,maskClosable:!0,slots:{default:function(e,t){var o=m.showErrorStatus,i=m.dragToUpload,n=m.dragSort,a=g.isActivated,r=g.isDragMove,l=g.isDragUploadStatus,u=g.dragIndex,d=g.fileList,s=c.computeIsDisabled,p={};return i&&-1===u&&(p.dragover=c.handleUploadDragoverEvent,p.dragleave=c.handleUploadDragleaveEvent,p.drop=c.handleUploadDropEvent),t("div",{attrs:{id:"refPopupElem".concat(f)},class:["vxe-upload--more-popup",{"is--readonly":v,"is--disabled":s,"is--active":a,"show--error":o,"is--drag":l}],on:p},[h?n?t("transition-group",{props:{name:"vxe-upload--drag-list".concat(r?"":"-disabled"),tag:"div"},class:"vxe-upload--image-more-list"},c.renderImageItemList(t,d,!0).concat(c.renderImageAction(t,!0))):t("div",{class:"vxe-upload--image-more-list"},c.renderImageItemList(t,d,!0).concat(c.renderImageAction(t,!0))):t("div",{class:"vxe-upload--file-more-list"},[c.renderFileAction(t,!0),n?t("transition-group",{props:{name:"vxe-upload--drag-list".concat(r?"":"-disabled"),tag:"div"},class:"vxe-upload--file-list"},c.renderFileItemList(t,d,!0)):t("div",{class:"vxe-upload--file-list"},c.renderFileItemList(t,d,!0))]),n?t("div",{attrs:{id:"refModalDragLineElem".concat(f)},class:"vxe-upload--drag-line"}):(0,_ui.renderEmptyElement)(c),l?t("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_ui.renderEmptyElement)(c)])}},events:{show:function(){g.showMorePopup=!0},hide:function(){g.showMorePopup=!1}}})},handleDragSortDragstartEvent:function(e){var t=this.reactData,o=(e.stopPropagation(),e.dataTransfer&&e.dataTransfer.setDragImage((0,_dom.getTpImg)(),0,0),e.currentTarget),e=o.parentElement,e=_xeUtils.default.findIndexOf(Array.from(e.children),function(e){return o===e});t.isDragMove=!0,t.dragIndex=e,setTimeout(function(){t.isDragMove=!1},500)},handleDragSortDragoverEvent:function(e){var t,o,i,n,a=this,r=a.reactData,l=a.internalData,r=(e.stopPropagation(),e.preventDefault(),r.dragIndex);-1!==r&&(t=a.computeIsImage,i=(o=e.currentTarget).parentElement,i=_xeUtils.default.findIndexOf(Array.from(i.children),function(e){return o===e}),n="",n=t?e.clientX-o.getBoundingClientRect().x<o.clientWidth/2?"left":"right":e.clientY-o.getBoundingClientRect().y<o.clientHeight/2?"top":"bottom",r===i?showDropTip(a,e,o,n):(showDropTip(a,e,o,n),l.prevDragIndex=i,l.prevDragPos=n))},handleDragSortDragendEvent:function(e){var t=this.reactData,o=this.internalData,i=t.fileList,n=o.prevDragIndex,o=o.prevDragPos,a=t.dragIndex,r="bottom"===o||"right"===o?1:0,l=i[a],u=i[n];l&&u&&(i.splice(a,1),n=_xeUtils.default.findIndexOf(i,function(e){return u===e})+r,i.splice(n,0,l),this.dispatchEvent("sort-dragend",{oldItem:l,newItem:u,dragPos:o,offsetIndex:r,_index:{newIndex:n,oldIndex:a}},e)),hideDropTip(this),t.dragIndex=-1},handleItemMousedownEvent:function(e){var t=this.$xeTable,o=this.reactData;t&&e.stopPropagation(),o.isActivated=!0},handleGlobalPasteEvent:function(e){var t=this.reactData,o=this.pasteToUpload;t.isActivated&&o&&(t=e.clipboardData||e.originalEvent.clipboardData)&&(o=t.items)&&(t=handleTransferFiles(o)).length&&(e.preventDefault(),this.uploadTransferFileEvent(e,t))},handleGlobalMousedownEvent:function(e){var t=this.reactData,o=this.$refs.refElem,i=this.$refs.refPopupElem,o=(0,_dom.getEventTargetNode)(e,o).flag;!o&&i&&(i=(i=i.parentElement||i)&&i.parentElement,o=(0,_dom.getEventTargetNode)(e,i).flag),t.isActivated=o},handleGlobalBlurEvent:function(){this.reactData.isActivated=!1},renderFileItemList:function(r,e,l){var u=this,t=u.$scopedSlots,d=u.showRemoveButton,s=u.showDownloadButton,p=u.showProgress,c=u.progressText,m=u.showPreview,g=u.showErrorStatus,f=u.dragSort,v=u.reactData.fileCacheMaps,h=u.computeIsDisabled,_=u.computeFormReadonly,x=u.computeNameProp,y=u.computeTypeProp,E=t.corner,I={};return f&&1<e.length&&(I.dragstart=u.handleDragSortDragstartEvent,I.dragover=u.handleDragSortDragoverEvent,I.dragend=u.handleDragSortDragendEvent),e.map(function(t,o){var e=u.getFieldKey(t),i=v[e],n=i&&i.loading,a=i&&"error"===i.status;return r("div",{key:f?e:o,class:["vxe-upload--file-item",{"is--preview":m,"is--loading":n,"is--error":a}],attrs:{fileid:e,draggable:!!f||null},on:I},[r("div",{class:"vxe-upload--file-item-icon"},[r("i",{class:(0,_ui.getIcon)()["UPLOAD_FILE_TYPE_".concat("".concat(t[y]).toLocaleUpperCase())]||(0,_ui.getIcon)().UPLOAD_FILE_TYPE_DEFAULT})]),r("div",{class:"vxe-upload--file-item-name",on:{click:function(e){n||a||u.handlePreviewFileEvent(e,t)}}},"".concat(t[x]||"")),n?r("div",{class:"vxe-upload--file-item-loading-icon"},[r("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]):(0,_ui.renderEmptyElement)(u),p&&n&&i?r("div",{class:"vxe-upload--file-item-loading-text"},c?_xeUtils.default.toFormatString("".concat(_xeUtils.default.isFunction(c)?c({}):c),{percent:i.percent}):(0,_ui.getI18n)("vxe.upload.uploadProgress",[i.percent])):(0,_ui.renderEmptyElement)(u),g&&a?r("div",{class:"vxe-upload--image-item-error"},[r(_button.default,{props:{icon:(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD,mode:"text",status:"primary",content:(0,_ui.getI18n)("vxe.upload.reUpload")},on:{click:function(){u.handleReUpload(t)}}})]):(0,_ui.renderEmptyElement)(u),r("div",{class:"vxe-upload--file-item-btn-wrapper"},[E?r("div",{class:"vxe-upload--file-item-corner"},(0,_vn.getSlotVNs)(E({option:t,isMoreView:l,readonly:_}))):(0,_ui.renderEmptyElement)(u),s&&!n?r("div",{class:"vxe-upload--file-item-download-btn",on:{click:function(e){u.downloadFileEvent(e,t)}}},[r("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_DOWNLOAD})]):(0,_ui.renderEmptyElement)(u),!d||_||h||n?(0,_ui.renderEmptyElement)(u):r("div",{class:"vxe-upload--file-item-remove-btn",on:{click:function(e){u.removeFileEvent(e,t,o)}}},[r("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_REMOVE})])])])})},renderFileAction:function(e,t){var o=this,i=o.$scopedSlots,n=o.showUploadButton,a=o.buttonText,r=o.buttonIcon,l=o.showButtonText,u=o.showButtonIcon,d=o.autoHiddenButton,s=o.computeIsDisabled,p=o.computedShowTipText,c=o.computedDefTipText,m=o.computeOverCount,g=i.default,i=i.tip||i.hint;return o.computeFormReadonly||!n?(0,_ui.renderEmptyElement)(o):e("div",{class:"vxe-upload--file-action"},[d&&m?(0,_ui.renderEmptyElement)(o):e("div",{class:"vxe-upload--file-action-btn",on:{click:o.clickEvent}},g?(0,_vn.getSlotVNs)(g({$upload:o})):[e(_button.default,{class:"vxe-upload--file-action-button",props:{content:t||l?a?"".concat(_xeUtils.default.isFunction(a)?a({}):a):(0,_ui.getI18n)("vxe.upload.fileBtnText"):"",icon:u?r||(0,_ui.getIcon)().UPLOAD_FILE_ADD:"",disabled:s}})]),p&&(c||i)?e("div",{class:"vxe-upload--file-action-tip"},i?(0,_vn.getSlotVNs)(i({$upload:o})):"".concat(c)):(0,_ui.renderEmptyElement)(o)])},renderAllMode:function(e){var t=this,o=t.reactData,i=t.showList,n=t.moreConfig,a=t.dragSort,r=o.fileList,o=o.isDragMove,l=t.computeMoreOpts,u=l.maxCount,d=l.showMoreButton,l="horizontal"===l.layout,s=r,p=0;return u&&r.length>u&&(p=r.length-u,s=r.slice(0,u)),e("div",{key:"all",class:"vxe-upload--file-wrapper"},i?[d&&n&&l?(0,_ui.renderEmptyElement)(t):t.renderFileAction(e,!0),s.length||d&&l?e("div",{class:["vxe-upload--file-list-wrapper",{"is--horizontal":l}]},[s.length?a?e("transition-group",{attrs:{name:"vxe-upload--drag-list".concat(o?"":"-disabled"),tag:"div"},class:"vxe-upload--file-list"},t.renderFileItemList(e,s,!1)):e("div",{class:"vxe-upload--file-list"},t.renderFileItemList(e,s,!1)):(0,_ui.renderEmptyElement)(t),d&&p?e("div",{class:"vxe-upload--file-over-more"},[e(_button.default,{props:{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[r.length]),status:"primary"},on:{click:t.handleMoreEvent}})]):(0,_ui.renderEmptyElement)(t),d&&n&&l?t.renderFileAction(e,!1):(0,_ui.renderEmptyElement)(t)]):(0,_ui.renderEmptyElement)(t)]:[t.renderFileAction(e,!1)])},renderImageItemList:function(r,e,l){var u=this,t=u.$scopedSlots,d=u.showRemoveButton,s=u.showProgress,p=u.progressText,c=u.showPreview,m=u.showErrorStatus,g=u.dragSort,f=u.reactData.fileCacheMaps,v=u.computeIsDisabled,h=u.computeFormReadonly,_=u.computeImageOpts,x=u.computeImgStyle,y=t.corner,E={};return g&&1<e.length&&(E.dragstart=u.handleDragSortDragstartEvent,E.dragover=u.handleDragSortDragoverEvent,E.dragend=u.handleDragSortDragendEvent),e.map(function(t,o){var e=u.getFieldKey(t),i=f[e],n=i&&i.loading,a=i&&"error"===i.status;return r("div",{key:g?e:o,class:["vxe-upload--image-item",{"is--preview":c,"is--circle":_.circle,"is--loading":n,"is--error":a}],attrs:{fileid:e,draggable:!!g||null},on:E},[r("div",{class:"vxe-upload--image-item-box",style:l?{}:x,attrs:{title:(0,_ui.getI18n)("vxe.upload.viewItemTitle")},on:{click:function(e){n||a||u.handlePreviewImageEvent(e,t,o)}}},[n&&i?r("div",{class:"vxe-upload--image-item-loading"},[r("div",{class:"vxe-upload--image-item-loading-icon"},[r("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]),s?r("div",{class:"vxe-upload--image-item-loading-text"},p?_xeUtils.default.toFormatString("".concat(_xeUtils.default.isFunction(p)?p({}):p),{percent:i.percent}):(0,_ui.getI18n)("vxe.upload.uploadProgress",[i.percent])):(0,_ui.renderEmptyElement)(u)]):(0,_ui.renderEmptyElement)(u),n?(0,_ui.renderEmptyElement)(u):a&&m?r("div",{class:"vxe-upload--image-item-error"},[r(_button.default,{props:{icon:(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD,mode:"text",status:"primary",content:(0,_ui.getI18n)("vxe.upload.reUpload")},on:{click:function(){u.handleReUpload(t)}}})]):r("div",{class:"vxe-upload--image-item-img-wrapper"},[r("img",{class:"vxe-upload--image-item-img",attrs:{src:u.getThumbnailFileUrl(t)}})]),r("div",{class:"vxe-upload--image-item-btn-wrapper",on:{click:function(e){e.stopPropagation()}}},[y?r("div",{class:"vxe-upload--file-item-corner"},(0,_vn.getSlotVNs)(y({option:t,isMoreView:l,readonly:h}))):(0,_ui.renderEmptyElement)(u),!d||h||v||n?(0,_ui.renderEmptyElement)(u):r("div",{class:"vxe-upload--image-item-remove-btn",on:{click:function(e){e.stopPropagation(),u.removeFileEvent(e,t,o)}}},[r("i",{class:(0,_ui.getIcon)().UPLOAD_IMAGE_REMOVE})])])])])})},renderImageAction:function(e,t){var o=this,i=o.$scopedSlots,n=o.showUploadButton,a=o.buttonText,r=o.buttonIcon,l=o.showButtonText,u=o.showButtonIcon,d=o.computedShowTipText,s=o.computedDefTipText,p=o.computeImgStyle,c=i.default,i=i.tip||i.hint;return o.computeFormReadonly||!n||o.autoHiddenButton&&o.computeOverCount?(0,_ui.renderEmptyElement)(o):e("div",{key:"action",class:"vxe-upload--image-action"},[e("div",{class:"vxe-upload--image-action-btn",on:{click:o.clickEvent}},c?c({$upload:o}):[e("div",{class:"vxe-upload--image-action-box",style:t?{}:p},[u?e("div",{class:"vxe-upload--image-action-icon"},[e("i",{class:r||(0,_ui.getIcon)().UPLOAD_IMAGE_ADD})]):(0,_ui.renderEmptyElement)(o),t||l?e("div",{class:"vxe-upload--image-action-content"},a?"".concat(_xeUtils.default.isFunction(a)?a({}):a):(0,_ui.getI18n)("vxe.upload.imgBtnText")):(0,_ui.renderEmptyElement)(o),d&&(s||i)?e("div",{class:"vxe-upload--image-action-hint"},i?(0,_vn.getSlotVNs)(i({$upload:o})):"".concat(s)):(0,_ui.renderEmptyElement)(o)])])])},renderImageMode:function(e){var t=this,o=t.reactData,i=t.showList,n=t.dragSort,a=o.fileList,o=o.isDragMove,r=t.computeMoreOpts,l=r.maxCount,r=r.showMoreButton,u=a,d=0;return l&&a.length>l&&(d=a.length-l,u=a.slice(0,l)),e("div",{key:"image",class:"vxe-upload--image-wrapper"},i?[n?e("transition-group",{attrs:{name:"vxe-upload--drag-list".concat(o?"":"-disabled"),tag:"div"},class:"vxe-upload--image-list"},t.renderImageItemList(e,u,!1).concat([r&&d?e("div",{key:"om",class:"vxe-upload--image-over-more"},[e(_button.default,{props:{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[a.length]),status:"primary"},on:{click:t.handleMoreEvent}})]):(0,_ui.renderEmptyElement)(t),t.renderImageAction(e,!1)])):e("div",{class:"vxe-upload--image-list"},t.renderImageItemList(e,u,!1).concat([r&&d?e("div",{class:"vxe-upload--image-over-more"},[e(_button.default,{props:{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[a.length]),status:"primary"},on:{click:t.handleMoreEvent}})]):(0,_ui.renderEmptyElement)(t),t.renderImageAction(e,!1)]))]:[e("div",{class:"vxe-upload--image-list"},[t.renderImageAction(e,!1)])])},renderVN:function(e){var t=this,o=t.reactData,i=t.showErrorStatus,n=t.pasteToUpload,a=t.dragSort,r=o.isDragUploadStatus,l=o.showMorePopup,u=o.isActivated,d=t.computeSize,s=t.computeIsDisabled,p=t.computeFormReadonly,c=t.computeIsImage,m={};return t.dragToUpload&&-1===o.dragIndex&&(m.dragover=t.handleUploadDragoverEvent,m.dragleave=t.handleUploadDragleaveEvent,m.drop=t.handleUploadDropEvent),e("div",{ref:"refElem",class:["vxe-upload",_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(d),d),"is--active",u),"is--readonly",p),"is--disabled",s),"is--paste",n),"show--error",i),"is--drag",r)],on:m},[c?t.renderImageMode(e):t.renderAllMode(e),a?e("div",{ref:"refDragLineElem",class:"vxe-upload--drag-line"}):(0,_ui.renderEmptyElement)(t),r&&!l?e("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_ui.renderEmptyElement)(t)])}},created:function(){this.updateFileList()},mounted:function(){var e=this,t=e;t.multiple&&t.singleMode&&(0,_log.errLog)("vxe.error.errConflicts",["multiple","single-mode"]),t.imageStyle&&(0,_log.warnLog)("vxe.error.delProp",["image-style","image-config"]),t.dragSort&&(0,_dom.initTpImg)(),_ui.globalEvents.on(e,"paste",e.handleGlobalPasteEvent),_ui.globalEvents.on(e,"mousedown",e.handleGlobalMousedownEvent),_ui.globalEvents.on(e,"blur",e.handleGlobalBlurEvent)},beforeDestroy:function(){this.reactData.isDragUploadStatus=!1,_ui.globalEvents.off(this,"paste"),_ui.globalEvents.off(this,"mousedown"),_ui.globalEvents.off(this,"blur")},render:function(e){return this.renderVN(e)}});