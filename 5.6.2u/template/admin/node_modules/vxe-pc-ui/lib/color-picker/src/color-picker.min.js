Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_util=require("./util"),_button=_interopRequireDefault(require("../../button/src/button")),_input=_interopRequireDefault(require("../../input/src/input"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,l){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var l=e[Symbol.toPrimitive];if(void 0===l)return("string"===t?String:Number)(e);l=l.call(e,t||"default");if("object"!=_typeof(l))return l;throw new TypeError("@@toPrimitive must return a primitive value.")}var WinEyeDropper="undefined"!=typeof window?window.EyeDropper:null,_default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeColorPicker",mixins:[_ui.globalMixins.sizeMixin],model:{prop:"value",event:"modelValue"},props:{value:String,placeholder:String,clearable:{type:Boolean,default:function(){return(0,_ui.getConfig)().colorPicker.clearable}},type:{type:String,default:function(){return(0,_ui.getConfig)().colorPicker.type}},size:{type:String,default:function(){return(0,_ui.getConfig)().colorPicker.size||(0,_ui.getConfig)().size}},className:[String,Function],popupClassName:[String,Function],colors:{type:Array,default:function(){return _xeUtils.default.clone((0,_ui.getConfig)().colorPicker.colors,!0)||[]}},showAlpha:{type:Boolean,default:function(){return(0,_ui.getConfig)().colorPicker.showAlpha}},showEyeDropper:{type:Boolean,default:function(){return(0,_ui.getConfig)().colorPicker.showEyeDropper}},showColorExtractor:{type:Boolean,default:function(){return(0,_ui.getConfig)().colorPicker.showColorExtractor}},showQuick:{type:Boolean,default:function(){return(0,_ui.getConfig)().colorPicker.showQuick}},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},clickToCopy:{type:Boolean,default:function(){return(0,_ui.getConfig)().colorPicker.clickToCopy}},placement:String,transfer:{type:Boolean,default:null}},inject:{$xeModal:{default:null},$xeDrawer:{default:null},$xeTable:{default:null},$xeForm:{default:null},formItemInfo:{from:"xeFormItemInfo",default:null}},provide:function(){return{$xeColorPicker:this}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{initialized:!1,selectColor:"",panelColor:"",hexValue:"",rValue:0,gValue:0,bValue:0,aValue:0,panelIndex:0,panelStyle:{},panelPlacement:null,visiblePanel:!1,isAniVisible:!1,isActivated:!1},internalData:{hpTimeout:void 0}}},computed:Object.assign(Object.assign({},{}),{computeFormReadonly:function(){var e=this.$xeForm,t=this.readonly;return null===t?!!e&&e.readonly:t},computeIsDisabled:function(){var e=this.$xeForm,t=this.disabled;return null===t?!!e&&e.disabled:t},computeBtnTransfer:function(){var e=this,t=e.$xeTable,l=e.$xeModal,o=e.$xeDrawer,n=e.$xeForm,e=e.transfer;if(null===e){var r=(0,_ui.getConfig)().colorPicker.transfer;if(_xeUtils.default.isBoolean(r))return r;if(t||l||o||n)return!0}return e},computeColorList:function(){var e=this.colors;return e?e.map(function(e){return _xeUtils.default.isString(e)?{label:e,value:e}:{label:_xeUtils.default.eqNull(e.label)?e.value:e.label,value:e.value}}):[]},computeValueType:function(){var e=this.type;return"rgb"===e||"rgba"===e?"rgb":"hex"},computeIsRgb:function(){return"rgb"===this.computeValueType}}),methods:{dispatchEvent:function(e,t,l){this.$emit(e,(0,_ui.createEvent)(l,{$colorPicker:this},t))},emitModel:function(e){var t=this._events;t&&t.modelValue?this.$emit("modelValue",e):this.$emit("model-value",e)},updateMode:function(){var e=this.reactData,t=this.value;e.selectColor=_xeUtils.default.toValueString(t),this.updateModelColor()},updateModelColor:function(){var e=this,t=e.reactData,l=t.selectColor,o=t.isAniVisible,n=e.computeIsRgb,r=e.$refs.refHueSliderElem,i=e.$refs.refAlphaSliderElem,l=(0,_util.parseColor)(l);t.hexValue=l.hex,t.rValue=l.r,t.gValue=l.g,t.bValue=l.b,t.aValue=l.a,l.value&&(n?"hex"===l.type&&(n=(0,_util.hexToRgb)(l.hex))&&(t.rValue=n.r,t.gValue=n.g,t.bValue=n.b,t.aValue=n.a):"hex"!==l.type&&(t.hexValue=(0,_util.rgbToHex)(l))),o&&(n="hex"===l.type?(0,_util.hexToHsv)(l.hex):(0,_util.rgbToHsv)(l),t=e.$refs.refColorPanelElem,n&&(t&&(o=t.clientHeight*(1-n.v),t=t.clientWidth*n.s,e.handlePanelColor(t,o)),r)&&e.handleHueColor(_xeUtils.default.ceil((1-n.h/360)*r.clientWidth)),i)&&e.handleAlphaColor(i.clientWidth*l.a)},updateZindex:function(){var e=this.reactData;e.panelIndex<(0,_utils.getLastZIndex)()&&(e.panelIndex=(0,_utils.nextZIndex)())},updatePlacement:function(){function e(){var e=(0,_dom.updatePanelPlacement)(r,i,{placement:o,teleportTo:a}),t=Object.assign(e.style,{zIndex:n});l.panelStyle=t,l.panelPlacement=e.placement}var t=this,l=t.reactData,o=t.placement,n=l.panelIndex,r=t.$refs.refElem,i=t.$refs.refOptionPanel,a=t.computeBtnTransfer;return e(),t.$nextTick().then(e)},showOptionPanel:function(){var e=this,t=e.reactData,l=e.internalData,o=l.hpTimeout;e.computeIsDisabled||(o&&(clearTimeout(o),l.hpTimeout=void 0),o=e.computeBtnTransfer,l=e.$refs.refOptionPanel,t.initialized||(t.initialized=!0,o&&l&&document.body.appendChild(l)),t.isActivated=!0,t.isAniVisible=!0,setTimeout(function(){e.updateModelColor(),t.visiblePanel=!0},10),e.updateZindex(),e.updatePlacement())},hideOptionPanel:function(){var e=this.reactData,t=this.internalData;e.visiblePanel=!1,t.hpTimeout=setTimeout(function(){e.isAniVisible=!1},350)},changeEvent:function(e,t){var l=this,o=l,n=l.reactData,r=l.$xeForm,i=l.formItemInfo;(n.selectColor=t)!==o.value&&(l.emitModel(t),l.dispatchEvent("change",{value:t},e),r)&&i&&r.triggerItemEvent(e,i.itemConfig.field,t)},clearValueEvent:function(e,t){this.changeEvent(e,t),this.dispatchEvent("clear",{value:t},e)},focusEvent:function(){var e=this.reactData;this.computeIsDisabled||e.visiblePanel||this.showOptionPanel()},blurEvent:function(){this.reactData.isActivated=!1},clearEvent:function(e){this.clearValueEvent(e,null),this.hideOptionPanel()},confirmEvent:function(e){var t=this.reactData.selectColor;this.changeEvent(e,t),this.hideOptionPanel()},togglePanelEvent:function(e){var t=this.reactData;e.preventDefault(),t.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},clickEvent:function(e){this.togglePanelEvent(e),this.dispatchEvent("click",{},e)},handleHueColor:function(e){var t=this.reactData,l=this.$refs.refHueSliderElem,o=this.$refs.refHueSliderBtnElem;if(l&&o){e<0&&(e=0);var l=_xeUtils.default.toInteger(l.clientWidth),n=255,l=_xeUtils.default.ceil(1530/l*e),r=l%n,i=0,a=0,u=0;switch(Math.ceil(l/n)){case 1:i=n,u=r;break;case 2:i=n-r,u=n;break;case 3:a=r,u=n;break;case 4:u=(a=n)-r;break;case 5:i=r,a=n;break;case 6:a=(i=n)-r}t.panelColor=(0,_util.toRgb)(i,a,u),o.style.left=(0,_dom.toCssUnit)(e)}},handleHueBarEvent:function(e){var t=this.$refs.refHueSliderElem,l=this.$refs.refHueSliderBtnElem;t&&l&&(l=t.getBoundingClientRect(),t=_xeUtils.default.toInteger(t.clientWidth),t=_xeUtils.default.ceil(Math.min(t-1,Math.max(1,e.clientX-l.x))),this.handleHueColor(t))},handleHueSliderMousedownEvent:function(e){var t=this;e.preventDefault(),document.onmousemove=function(e){e.preventDefault(),t.handleHueBarEvent(e)},document.onmouseup=function(e){document.onmousemove=null,document.onmouseup=null,t.handleHueBarEvent(e)}},handleAlphaColor:function(e){var t=this.reactData,l=t.selectColor,o=this.$refs.refAlphaSliderElem,n=this.$refs.refAlphaSliderBtnElem;o&&n&&(o=o.getBoundingClientRect().width,o=_xeUtils.default.ceil(100/o*(e=o<(e=e<0?0:e)?o:e)/100,2),t.aValue=o,n.style.left=(0,_dom.toCssUnit)(e),t.selectColor=(0,_util.updateColorAlpha)(l,o))},handleAlphaBarEvent:function(e){var t=this.$refs.refAlphaSliderElem,l=this.$refs.refAlphaSliderBtnElem;t&&l&&(t=(l=t.getBoundingClientRect()).width,t=Math.min(t,Math.max(0,e.clientX-l.x)),this.handleAlphaColor(t),this.updateModelColor())},handleAlphaSliderMousedownEvent:function(e){var t=this;e.preventDefault(),document.onmousemove=function(e){e.preventDefault(),t.handleAlphaBarEvent(e)},document.onmouseup=function(e){document.onmousemove=null,document.onmouseup=null,t.handleAlphaBarEvent(e)}},handleInputRgbEvent:function(){var e=this.reactData,t=e.rValue;e.selectColor=(0,_util.toRgb)(t,e.gValue,e.bValue,e.aValue),this.updateModelColor()},handleInputAlphaEvent:function(){var e=this.reactData.aValue,t=this.$refs.refAlphaSliderElem,l=this.$refs.refAlphaSliderBtnElem;t&&l&&(l=t.getBoundingClientRect().width,this.handleAlphaColor(l*e))},handleQuickEvent:function(e,t){var l=this.reactData,t=t.value;l.selectColor=t,this.updateModelColor()},handlePanelColor:function(e,t){var l=this.$refs.refColorActiveElem;l&&(l.style.top=(0,_dom.toCssUnit)(t),l.style.left=(0,_dom.toCssUnit)(e))},handleEyeDropperEvent:function(){var t=this,l=t.reactData;if(WinEyeDropper)try{(new WinEyeDropper).open().then(function(e){e&&e.sRGBHex&&(l.selectColor=e.sRGBHex,t.updateModelColor())}).catch(function(){})}catch(e){}},handleSelectColorMousedownEvent:function(e){var t,l=this,o=l.reactData,n=l.showAlpha,r=o.panelColor,i=o.aValue,a=l.$refs.refColorPanelElem,u=l.$refs.refColorActiveElem;a&&u&&(u=a.getBoundingClientRect(),t=e.clientY-u.y,e=e.clientX-u.x,u=(0,_util.parseColor)(r))&&(r="hex"===u.type?(0,_util.hexToHsv)(u.hex):(0,_util.rgbToHsv)(u))&&(u=(0,_util.hsvToRgb)(r.h,e/a.clientWidth,1-t/a.clientHeight),o.selectColor=(0,_util.toRgb)(u.r,u.g,u.b,n?i:null),l.handlePanelColor(e,t),l.updateModelColor())},handleCopyColorEvent:function(){var e=this.reactData.selectColor;e&&_ui.VxeUI.clipboard.copy(e)&&_ui.VxeUI.modal&&_ui.VxeUI.modal.message({content:(0,_ui.getI18n)("vxe.colorPicker.copySuccess",[e]),status:"success"})},handleGlobalMousewheelEvent:function(e){var t=this,l=t.reactData.visiblePanel;t.computeIsDisabled||l&&(l=t.$refs.refOptionPanel,(0,_dom.getEventTargetNode)(e,l).flag?t.updatePlacement():t.hideOptionPanel())},handleGlobalMousedownEvent:function(e){var t,l,o=this,n=o.reactData,r=n.visiblePanel;o.computeIsDisabled||(t=o.$refs.refElem,l=o.$refs.refOptionPanel,n.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,l).flag,r&&!n.isActivated&&o.hideOptionPanel())},handleGlobalBlurEvent:function(){this.hideOptionPanel()},renderColorWrapper:function(e){var t=this.reactData,l=this.showColorExtractor,t=t.panelColor;return l?e("div",{ref:"refColorPanelElem",class:"vxe-color-picker--color-wrapper",on:{mousedown:this.handleSelectColorMousedownEvent}},[e("div",{class:"vxe-color-picker--color-bg",style:{backgroundColor:t}}),e("div",{class:"vxe-color-picker--white-bg"}),e("div",{class:"vxe-color-picker--black-bg"}),e("div",{ref:"refColorActiveElem",class:"vxe-color-picker--color-active"})]):(0,_ui.renderEmptyElement)(this)},renderColorBar:function(e){var t=this,l=t.reactData,o=t.showAlpha,n=t.clickToCopy,r=l.hexValue,i=l.rValue,a=l.gValue,u=l.bValue,c=l.aValue,s=l.selectColor,p=l.panelColor,d=t.computeValueType,f=t.computeIsRgb;return e("div",{class:"vxe-color-picker--bar-wrapper"},[e("div",{class:"vxe-color-picker--slider-wrapper"},[t.showEyeDropper&&WinEyeDropper?e("div",{class:"vxe-color-picker--color-dropper"},[e("span",{class:"vxe-color-picker--color-dropper-btn",on:{click:t.handleEyeDropperEvent}},[e("i",{class:(0,_ui.getIcon)().EYE_DROPPER})])]):(0,_ui.renderEmptyElement)(t),e("div",{class:"vxe-color-picker--slider-preview"},[e("div",{class:"vxe-color-picker--preview-btn"},[e("div",{class:"vxe-color-picker--preview-color",style:{backgroundColor:s}},n?[e("span",{class:"vxe-color-picker--preview-copy-btn",on:{click:t.handleCopyColorEvent}},[e("i",{class:(0,_ui.getIcon)().COLOR_COPY})])]:[])])]),e("div",{class:"vxe-color-picker--slider-handle"},[e("div",{ref:"refHueSliderElem",class:"vxe-color-picker--bar-hue-slider",on:{click:t.handleHueBarEvent}},[e("div",{ref:"refHueSliderBtnElem",class:"vxe-color-picker--bar-hue-btn",on:{mousedown:t.handleHueSliderMousedownEvent}})]),o?e("div",{ref:"refAlphaSliderElem",class:"vxe-color-picker--bar-alpha-slider",on:{click:t.handleAlphaBarEvent}},[e("div",{class:"vxe-color-picker--bar-alpha-bg",style:{background:"linear-gradient(to right, rgba(0, 0, 0, 0), ".concat(p,")")}}),e("div",{ref:"refAlphaSliderBtnElem",class:"vxe-color-picker--bar-alpha-btn",on:{mousedown:t.handleAlphaSliderMousedownEvent}})]):(0,_ui.renderEmptyElement)(t)])]),e("div",{class:"vxe-color-picker--".concat(d,"-wrapper")},f?[e("div",{class:"vxe-color-picker--input-wrapper"},[e(_input.default,{props:{type:"integer",size:"mini",align:"center",min:0,max:255,maxLength:3,placeholder:"",value:i},on:{modelValue:function(e){l.rValue=e},change:t.handleInputRgbEvent}}),e(_input.default,{props:{type:"integer",size:"mini",align:"center",min:0,max:255,maxLength:3,placeholder:"",value:a},on:{modelValue:function(e){l.gValue=e},change:t.handleInputRgbEvent}}),e(_input.default,{props:{type:"integer",size:"mini",align:"center",min:0,max:255,maxLength:3,placeholder:"",value:u},on:{modelValue:function(e){l.bValue=e},change:t.handleInputRgbEvent}}),e(_input.default,{props:{type:"number",size:"mini",align:"center",min:0,max:1,step:.01,maxLength:4,placeholder:"",value:c},on:{modelValue:function(e){l.aValue=e},change:t.handleInputAlphaEvent}})]),e("div",{class:"vxe-color-picker--input-title"},[e("span","R"),e("span","G"),e("span","B"),e("span","A")])]:[e("div",{class:"vxe-color-picker--input-title"},"HEX"),e("div",{class:"vxe-color-picker--input-wrapper"},[e(_input.default,{props:{type:"text",size:"mini",align:"center",maxLength:9,placeholder:"",value:r},on:{modelValue:function(e){l.hexValue=e},change:function(){var e=(0,_util.parseColor)(l.hexValue);e&&e.value&&(l.selectColor=e.value,t.updateModelColor())}}})])])])},renderQuickWrapper:function(l){var o=this,e=o.showQuick,t=o.computeColorList;return e&&t.length?l("div",{class:"vxe-color-picker--quick-wrapper"},t.map(function(t,e){return l("div",{key:e,class:"vxe-color-picker--quick-item",attrs:{title:t.label||""},style:{backgroundColor:t.value},on:{click:function(e){o.handleQuickEvent(e,t)}}})})):(0,_ui.renderEmptyElement)(o)},renderVN:function(e){var t=this,l=t.reactData,o=t.className,n=t.popupClassName,r=t.clearable,i=t.value,a=l.initialized,u=l.isActivated,c=l.isAniVisible,s=l.visiblePanel,p=t.computeSize,d=t.computeIsDisabled,f=t.computeBtnTransfer;return t.computeFormReadonly?e("div",{ref:"refElem",class:["vxe-color-picker--readonly",o]},[e("div",{class:"vxe-color-picker--readonly-color",style:{backgroundColor:i}})]):e("div",{ref:"refElem",class:["vxe-color-picker",o?_xeUtils.default.isFunction(o)?o({$colorPicker:t}):o:"",_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(p),p),"is--selected",!!i),"is--visible",s),"is--disabled",d),"is--active",u)]},[e("input",{ref:"refInput",class:"vxe-color-picker--input",on:{focus:t.focusEvent,blur:t.blurEvent}}),e("div",{class:"vxe-color-picker--inner",on:{click:t.clickEvent}},[e("div",{class:"vxe-color-picker--inner-color",style:{backgroundColor:i}})]),e("div",{ref:"refOptionPanel",class:["vxe-table--ignore-clear vxe-color-picker--panel",n?_xeUtils.default.isFunction(n)?n({$colorPicker:t}):n:"",_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(p),p),"is--transfer",f),"ani--leave",c),"ani--enter",s)],attrs:{placement:l.panelPlacement},style:l.panelStyle},[a&&(s||c)?e("div",{class:"vxe-color-picker--panel-wrapper"},[t.renderColorWrapper(e),t.renderColorBar(e),t.renderQuickWrapper(e),e("div",{class:"vxe-color-picker--footer-wrapper"},[r?e(_button.default,{props:{content:(0,_ui.getI18n)("vxe.colorPicker.clear"),size:"mini"},on:{click:t.clearEvent}}):(0,_ui.renderEmptyElement)(t),e(_button.default,{props:{content:(0,_ui.getI18n)("vxe.colorPicker.confirm"),size:"mini",status:"primary"},on:{click:t.confirmEvent}})])]):(0,_ui.renderEmptyElement)(t)])])}},watch:{value:function(){this.updateMode()}},created:function(){var e=this;e.reactData.selectColor="".concat(e.value||""),e.updateMode(),_ui.globalEvents.on(e,"mousewheel",e.handleGlobalMousewheelEvent),_ui.globalEvents.on(e,"mousedown",e.handleGlobalMousedownEvent),_ui.globalEvents.on(e,"blur",e.handleGlobalBlurEvent)},beforeDestroy:function(){var e=this.$refs.refOptionPanel;e&&e.parentNode&&e.parentNode.removeChild(e),_ui.globalEvents.off(this,"mousewheel"),_ui.globalEvents.off(this,"mousedown"),_ui.globalEvents.off(this,"blur")},render:function(e){return this.renderVN(e)}});