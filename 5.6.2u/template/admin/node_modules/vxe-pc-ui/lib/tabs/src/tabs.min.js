Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_vn=require("../../ui/src/vn"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_log=require("../../ui/src/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeTabs",props:{value:[String,Number,Boolean],options:Array,height:[String,Number],destroyOnClose:Boolean,titleWidth:[String,Number],titleAlign:[String,Number],type:String,showClose:Boolean,padding:{type:Boolean,default:function(){return(0,_ui.getConfig)().tabs.padding}},trigger:String,beforeChangeMethod:Function,closeConfig:Object,refreshConfig:Object,beforeCloseMethod:Function},inject:{$xeParentTabs:{from:"$xeTabs",default:null}},provide:function(){return{$xeTabs:this}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{staticTabs:[],activeName:null,initNames:[],lintLeft:0,lintWidth:0,isTabOver:!1,resizeFlag:1,cacheTabMaps:{}},internalData:{slTimeout:void 0}}},computed:Object.assign(Object.assign({},{}),{computeParentResizeFlag:function(){var e=this.$xeParentTabs;return e?e.reactData.resizeFlag:null},computeCloseOpts:function(){return Object.assign({},(0,_ui.getConfig)().tabs.closeConfig,this.closeConfig)},computeRefreshOpts:function(){return Object.assign({},(0,_ui.getConfig)().tabs.refreshConfig,this.refreshConfig)},computeTabOptions:function(){var t=this;return(t.options||[]).filter(function(e){return t.handleFilterTab(e)})},computeTabStaticOptions:function(){var t=this;return t.reactData.staticTabs.filter(function(e){return t.handleFilterTab(e)})}}),methods:{dispatchEvent:function(e,t,a){this.$emit(e,(0,_ui.createEvent)(a,{$tabs:this},t))},emitModel:function(e){var t=this,a=t._events;t.$emit("input",e),a&&a.modelValue?t.$emit("modelValue",e):t.$emit("model-value",e)},prev:function(){return this.handlePrevNext(!1)},next:function(){return this.handlePrevNext(!0)},prevTab:function(){return(0,_log.warnLog)("vxe.error.delFunc",["prevTab","prev"]),this.prev()},nextTab:function(){return(0,_log.warnLog)("vxe.error.delFunc",["nextTab","next"]),this.next()},handleFilterTab:function(e){e=e.permissionCode;return!(e&&!_ui.permission.checkVisible(e))},callSlot:function(e,t,a){var n=this.$scopedSlots;return e&&(_xeUtils.default.isString(e)&&(e=n[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e.call(this,t,a)):[]},updateTabStyle:function(){var l=this,c=l,u=l.reactData;l.$nextTick(function(){var e=c.type,t=u.activeName,a=l.computeTabOptions,n=l.computeTabStaticOptions,i=l.$refs.refHeadWrapperElem,r=0,o=0,s=!1;i&&(n=_xeUtils.default.findIndexOf(n.length?n:a,function(e){return e.name===t}),a=i.children,s=i.scrollWidth!==i.clientWidth,-1<n)&&(a=(i=a[n]).clientWidth,e?"card"===e?(r=a+2,o=i.offsetLeft):"border-card"===e&&(r=a+2,o=i.offsetLeft-1):(r=Math.max(4,Math.floor(.6*a)),o=i.offsetLeft+Math.floor((a-r)/2))),u.lintLeft=o,u.lintWidth=r,u.isTabOver=s})},addInitName:function(e,t){var a=this.reactData.initNames;return!(!e||a.includes(e)||(this.dispatchEvent("tab-load",{name:e},t),a.push(e),0))},initDefaultName:function(e){var a,n=this,t=n.reactData,i=null,r={};e&&e.length&&(a=!1,i=n.value,e.forEach(function(e){var e=e||{},t=e.name,e=e.preload;t&&(r["".concat(t)]={loading:!1},i===t&&(a=!0),e)&&n.addInitName(t,null)}),a||(i=e[0].name,n.addInitName(i,null),n.emitModel(i))),t.activeName=i,t.cacheTabMaps=r},clickEvent:function(t,a){var n=this,i=n.reactData,e=n.trigger,r=n.beforeChangeMethod||(0,_ui.getConfig)().tabs.beforeChangeMethod,o=i.activeName,s=a.name,l=s;n.dispatchEvent("tab-click",{name:s},t),"manual"!==e&&s!==o&&Promise.resolve(!r||r({$tabs:n,name:s,oldName:o,newName:s,option:a})).then(function(e){e?(i.activeName=s,n.emitModel(l),n.addInitName(s,t),n.dispatchEvent("change",{value:l,name:s,oldName:o,newName:s,option:a},t),n.dispatchEvent("tab-change",{value:l,name:s,oldName:o,newName:s,option:a},t)):n.dispatchEvent("tab-change-fail",{value:l,name:s,oldName:o,newName:s,option:a},t)}).catch(function(){n.dispatchEvent("tab-change-fail",{value:l,name:s,oldName:o,newName:s,option:a},t)})},handleRefreshTabEvent:function(e,t){var a=this.reactData,e=(e.stopPropagation(),a.activeName),a=a.cacheTabMaps,n=t.name,i=this.computeRefreshOpts.queryMethod,r=n?a["".concat(n)]:null;r&&(i?(r.loading=!0,Promise.resolve(i({$tabs:this,value:e,name:n,option:t})).finally(function(){r.loading=!1})):(0,_log.errLog)("vxe.error.notFunc",["refresh-config.queryMethod"]))},handleCloseTabEvent:function(t,e,a,n){var i=this,r=i,o=i.reactData,o=(t.stopPropagation(),o.activeName),r=i.computeCloseOpts.beforeMethod||r.beforeCloseMethod||(0,_ui.getConfig)().tabs.beforeCloseMethod,s=e.name,l=o,c=l;o===s&&(o=a<n.length-1?n[a+1]:n[a-1],c=o?o.name:null),Promise.resolve(!r||r({$tabs:i,value:l,name:s,nextName:c,option:e})).then(function(e){e?i.dispatchEvent("tab-close",{value:l,name:s,nextName:c},t):i.dispatchEvent("tab-close-fail",{value:l,name:s,nextName:c},t)}).catch(function(){i.dispatchEvent("tab-close-fail",{value:l,name:s,nextName:c},t)})},startScrollAnimation:function(i,e){var r=this,o=r.internalData,t=o.slTimeout,s=e,l=6,c=35,u=(t&&(clearTimeout(t),o.slTimeout=void 0),function(){var e,t,a,n=r.$refs.refHeadWrapperElem;0<l&&(l--,n)&&(e=n.clientWidth,t=n.scrollWidth,a=n.scrollLeft,s=Math.floor(s/2),0<i?e+a<t&&(n.scrollLeft+=s,c-=4,o.slTimeout=setTimeout(u,c)):0<a&&(n.scrollLeft-=s,c-=4,o.slTimeout=setTimeout(u,c)),r.updateTabStyle())});u()},handleScrollToLeft:function(e){var t=this.$refs.refHeadWrapperElem;t&&(t=Math.floor(.75*t.clientWidth),this.startScrollAnimation(e,t))},scrollLeftEvent:function(){this.handleScrollToLeft(-1)},scrollRightEvent:function(){this.handleScrollToLeft(1)},scrollToTab:function(r){var o=this,s=o.computeTabOptions,l=o.computeTabStaticOptions;return o.$nextTick().then(function(){var e,t,a,n,i=o.$refs.refHeadWrapperElem;i&&(-1<(n=_xeUtils.default.findIndexOf(l.length?l:s,function(e){return e.name===r}))&&(e=i.scrollLeft,t=i.clientWidth,n=i.children[n])&&(0<(n=(a=n.offsetLeft)+n.clientWidth-(e+t))&&(i.scrollLeft+=n),a<e)&&(i.scrollLeft=a),o.updateTabStyle())})},handlePrevNext:function(e){var t,a=this,n=a.reactData,i=n.activeName,r=a.computeTabStaticOptions,r=r.length?r:a.computeTabOptions,o=_xeUtils.default.findIndexOf(r,function(e){return e.name===i});return-1<o&&(t=null,e?o<r.length-1&&(t=r[o+1]):0<o&&(t=r[o-1]),t)&&(e=t.name,n.activeName=e,a.emitModel(e),a.addInitName(e,null)),a.$nextTick()},renderTabHeader:function(d,f){var h=this,e=h.$scopedSlots,t=h.reactData,a=h.type,m=h.titleWidth,v=h.titleAlign,p=h.showClose,b=h.closeConfig,g=h.refreshConfig,T=t.activeName,n=t.lintLeft,i=t.lintWidth,r=t.isTabOver,x=t.cacheTabMaps,t=e.extra,_=h.computeCloseOpts,E=_.visibleMethod,N=h.computeRefreshOpts,S=N.visibleMethod;return d("div",{class:"vxe-tabs-header"},[r?d("div",{class:"vxe-tabs-header--bar vxe-tabs-header--left-bar",on:{click:h.scrollLeftEvent}},[d("span",{class:(0,_ui.getIcon)().TABS_TAB_BUTTON_LEFT})]):(0,_ui.renderEmptyElement)(h),d("div",{class:"vxe-tabs-header--wrapper"},[d("div",{ref:"refHeadWrapperElem",class:"vxe-tabs-header--item-wrapper"},f.map(function(t,a){var e=t.title,n=t.icon,i=t.name,r=t.slots,r=r?r.title||r.tab:null,o=t.titleWidth||m,s=t.titleAlign||v,l={$tabs:h,value:T,name:i,option:t},c=T===i,u=i?x["".concat(i)]:null,u=!!u&&u.loading;return d("div",{key:"".concat(i),class:["vxe-tabs-header--item",s?"align--".concat(s):"",{"is--active":c}],style:o?{width:(0,_dom.toCssUnit)(o)}:{},on:{click:function(e){h.clickEvent(e,t)}}},[d("div",{class:"vxe-tabs-header--item-inner"},[d("div",{class:"vxe-tabs-header--item-content"},[n?d("span",{class:"vxe-tabs-header--item-icon"},[d("i",{class:n})]):(0,_ui.renderEmptyElement)(h),d("span",{class:"vxe-tabs-header--item-name"},r?h.callSlot(r,{name:i,title:e},d):"".concat(e))]),((0,_utils.isEnableConf)(g)||N.enabled)&&(S?S(l):c)?d("div",{class:"vxe-tabs-header--refresh-btn",on:{click:function(e){h.handleRefreshTabEvent(e,t)}}},[d("i",{class:u?(0,_ui.getIcon)().TABS_TAB_REFRESH_LOADING:(0,_ui.getIcon)().TABS_TAB_REFRESH})]):(0,_ui.renderEmptyElement)(h),!(p||(0,_utils.isEnableConf)(b)||_.enabled)||E&&!E(l)?(0,_ui.renderEmptyElement)(h):d("div",{class:"vxe-tabs-header--close-btn",on:{click:function(e){h.handleCloseTabEvent(e,t,a,f)}}},[d("i",{class:(0,_ui.getIcon)().TABS_TAB_CLOSE})])])])}).concat([d("span",{key:"line",class:"vxe-tabs-header--active-line type--".concat(a||"default"),style:{left:"".concat(n,"px"),width:"".concat(i,"px")}})]))]),r?d("div",{class:"vxe-tabs-header--bar vxe-tabs-header--right-bar",on:{click:h.scrollRightEvent}},[d("span",{class:(0,_ui.getIcon)().TABS_TAB_BUTTON_RIGHT})]):(0,_ui.renderEmptyElement)(h),t?d("div",{class:"vxe-tabs-header--extra"},h.callSlot(t,{},d)):(0,_ui.renderEmptyElement)(h)])},renderTabPane:function(e,t){var a=this.reactData,n=a.initNames,a=a.activeName,i=t.name,t=t.slots,t=t?t.default:null;return i&&n.includes(i)?e("div",{key:"".concat(i),class:["vxe-tabs-pane--item",{"is--visible":a===i,"has--content":!!t}]},t?this.callSlot(t,{name:i},e):[]):(0,_ui.renderEmptyElement)(this)},renderTabContent:function(t,e){var a=this,n=a.reactData,i=a.destroyOnClose,r=n.activeName,n=e.find(function(e){return e.name===r});return i?[n?a.renderTabPane(t,n):(0,_ui.renderEmptyElement)(a)]:e.map(function(e){return a.renderTabPane(t,e)})},renderVN:function(e){var t=this,a=t.$scopedSlots,n=t.type,i=t.height,r=t.padding,o=t.trigger,s=a.default,a=a.footer,l=s?t.computeTabStaticOptions:t.computeTabOptions;return e("div",{ref:"refElem",class:["vxe-tabs","vxe-tabs--".concat(n||"default"),"trigger--".concat("manual"===o?"trigger":"default"),{"is--padding":r,"is--height":i}],style:i?{height:(0,_dom.toCssUnit)(i)}:{}},[e("div",{class:"vxe-tabs-slots"},s?t.callSlot(s,{},e):[]),t.renderTabHeader(e,l),e("div",{class:"vxe-tabs-pane"},t.renderTabContent(e,l)),a?e("div",{class:"vxe-tabs-footer"},t.callSlot(a,{},e)):(0,_ui.renderEmptyElement)(t)])}},watch:{value:function(e){var t=this.reactData;this.addInitName(e,null),t.activeName=e},"reactData.activeName":function(e){var t=this.reactData;this.scrollToTab(e),this.$nextTick(function(){t.resizeFlag++})},options:function(){this.initDefaultName(this.options),this.updateTabStyle()},"reactData.staticTabs":function(){var e=this.reactData;this.initDefaultName(e.staticTabs),this.updateTabStyle()},computeParentResizeFlag:function(){var e=this;e.$nextTick(function(){e.updateTabStyle()})}},created:function(){var e=this.reactData;this.addInitName(this.value,null),this.initDefaultName(e.staticTabs.length?e.staticTabs:this.options)},mounted:function(){this.updateTabStyle(),_ui.globalEvents.on(this,"resize",this.updateTabStyle)},beforeDestroy:function(){_ui.globalEvents.off(this,"resize")},render:function(e){return this.renderVN(e)}});