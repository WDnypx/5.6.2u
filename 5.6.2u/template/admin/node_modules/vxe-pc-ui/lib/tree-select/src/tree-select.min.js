Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_log=require("../../ui/src/log"),_input=_interopRequireDefault(require("../../input/src/input")),_tree=_interopRequireDefault(require("../../tree/src/tree"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);n=n.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function getOptUniqueId(){return _xeUtils.default.uniqueId("node_")}var _default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeTreeSelect",mixins:[_ui.globalMixins.sizeMixin],model:{prop:"value",event:"modelValue"},props:{value:[String,Number,Array],clearable:Boolean,placeholder:{type:String,default:function(){return _xeUtils.default.eqNull((0,_ui.getConfig)().treeSelect.placeholder)?(0,_ui.getI18n)("vxe.base.pleaseSelect"):(0,_ui.getConfig)().treeSelect.placeholder}},readonly:{type:Boolean,default:null},loading:Boolean,disabled:{type:Boolean,default:null},multiple:Boolean,className:[String,Function],popupClassName:[String,Function],prefixIcon:String,placement:String,options:Array,optionProps:Object,size:{type:String,default:function(){return(0,_ui.getConfig)().select.size||(0,_ui.getConfig)().size}},remote:Boolean,remoteMethod:Function,popupConfig:Object,treeConfig:Object,transfer:{type:Boolean,default:null}},inject:{$xeModal:{default:null},$xeDrawer:{default:null},$xeTable:{default:null},$xeForm:{default:null},formItemInfo:{from:"xeFormItemInfo",default:null}},provide:function(){return{$xeTreeSelect:this}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{initialized:!1,fullOptionList:[],fullNodeMaps:{},panelIndex:0,panelStyle:{},panelPlacement:null,triggerFocusPanel:!1,visiblePanel:!1,isAniVisible:!1,isActivated:!1},internalData:{hpTimeout:void 0}}},computed:Object.assign(Object.assign({},{}),{computeFormReadonly:function(){var e=this.$xeForm,t=this.readonly;return null===t?!!e&&e.readonly:t},computeIsDisabled:function(){var e=this.$xeForm,t=this.disabled;return null===t?!!e&&e.disabled:t},computeBtnTransfer:function(){var e=this,t=e.$xeTable,n=e.$xeModal,i=e.$xeDrawer,o=e.$xeForm,e=e.transfer;if(null===e){var l=(0,_ui.getConfig)().treeSelect.transfer;if(_xeUtils.default.isBoolean(l))return l;if(t||n||i||o)return!0}return e},computePopupOpts:function(){return Object.assign({},(0,_ui.getConfig)().treeSelect.popupConfig,this.popupConfig)},computeTreeOpts:function(){return Object.assign({},(0,_ui.getConfig)().treeSelect.treeConfig,this.treeConfig)},computeTreeNodeOpts:function(){var e=this.computeTreeOpts;return Object.assign({isHover:!0},e.nodeConfig)},computeTreeCheckboxOpts:function(){var e=this.computeTreeOpts;return Object.assign({showIcon:!!e.showCheckbox},e.checkboxConfig,{trigger:"node"})},computeTreeRadioOpts:function(){var e=this.computeTreeOpts;return Object.assign({showIcon:!!e.showRadio},e.radioConfig,{trigger:"node"})},computePropsOpts:function(){return Object.assign({},this.optionProps)},computeNodeKeyField:function(){return this.computeTreeOpts.keyField||"id"},computeLabelField:function(){return this.computePropsOpts.label||"label"},computeValueField:function(){return this.computePropsOpts.value||"value"},computeChildrenField:function(){return this.computePropsOpts.children||"children"},computeParentField:function(){return this.computePropsOpts.parent||"parentField"},computeHasChildField:function(){return this.computePropsOpts.hasChild||"hasChild"},computeSelectLabel:function(){var e=this.reactData,t=this.value,n=e.fullNodeMaps,i=this.computeLabelField;return(_xeUtils.default.isArray(t)?t:[t]).map(function(e){var t=n[e];return t?t.item[i]:e}).join(", ")},computePopupWrapperStyle:function(){var e=this.computePopupOpts,t=e.height,e=e.width,n={};return e&&(n.width=(0,_dom.toCssUnit)(e)),t&&(n.height=(0,_dom.toCssUnit)(t),n.maxHeight=(0,_dom.toCssUnit)(t)),n}}),methods:{dispatchEvent:function(e,t,n){this.$emit(e,(0,_ui.createEvent)(n,{$treeSelect:this},t))},emitModel:function(e){var t=this._events;t&&t.modelValue?this.$emit("modelValue",e):this.$emit("model-value",e)},getNodeid:function(e){e=e[this.computeNodeKeyField];return e?encodeURIComponent(e):""},cacheDataMap:function(){var a=this,e=a.reactData,t=a.options,u=a.computeNodeKeyField,s=a.computeValueField,c={},p={};_xeUtils.default.eachTree(t,function(e,t,n,i,o,l){var r=(r=a.getNodeid(e))||getOptUniqueId(),r=(p[r]&&(0,_log.errLog)("vxe.error.repeatKey",[u,r]),p[r]=!0,e[s]);c[r]&&(0,_log.errLog)("vxe.error.repeatKey",[s,r]),c[r]={item:e,index:t,items:n,parent:o,nodes:l}},{children:a.computeChildrenField}),e.fullOptionList=t||[],e.fullNodeMaps=c},updateZindex:function(){var e=this.reactData;e.panelIndex<(0,_utils.getLastZIndex)()&&(e.panelIndex=(0,_utils.nextZIndex)())},updatePlacement:function(){function e(){var e=(0,_dom.updatePanelPlacement)(l,r,{placement:i,teleportTo:a}),t=Object.assign(e.style,{zIndex:o});n.panelStyle=t,n.panelPlacement=e.placement}var t=this,n=t.reactData,i=t.placement,o=n.panelIndex,l=t.$refs.refElem,r=t.$refs.refOptionPanel,a=t.computeBtnTransfer;return e(),t.$nextTick().then(e)},showOptionPanel:function(){var e,t=this,n=t.reactData,i=t.internalData;t.loading||t.computeIsDisabled||(i.hpTimeout&&clearTimeout(i.hpTimeout),n.initialized||(n.initialized=!0,i=t.computeBtnTransfer,e=t.$refs.refOptionPanel,i&&e&&document.body.appendChild(e)),n.isActivated=!0,n.isAniVisible=!0,setTimeout(function(){n.visiblePanel=!0},10),t.updateZindex(),t.updatePlacement())},hideOptionPanel:function(){var e=this.reactData,t=this.internalData;e.visiblePanel=!1,t.hpTimeout=setTimeout(function(){e.isAniVisible=!1},350)},changeEvent:function(e,t){var n=this,i=n,o=n.reactData,l=n.$xeForm,r=n.formItemInfo,o=o.fullNodeMaps;n.emitModel(t),t!==i.value&&(i=o[t],n.dispatchEvent("change",{value:t,option:i?i.item:null},e),l)&&r&&l.triggerItemEvent(e,r.itemConfig.field,t)},clearValueEvent:function(e,t){this.changeEvent(e,t),this.dispatchEvent("clear",{value:t},e)},clearEvent:function(e,t){this.clearValueEvent(t,null),this.hideOptionPanel()},handleGlobalMousewheelEvent:function(e){var t=this,n=t.reactData.visiblePanel;t.computeIsDisabled||n&&(n=t.$refs.refOptionPanel,(0,_dom.getEventTargetNode)(e,n).flag?t.updatePlacement():t.hideOptionPanel())},handleGlobalMousedownEvent:function(e){var t,n,i=this,o=i.reactData,l=o.visiblePanel;i.computeIsDisabled||(t=i.$refs.refElem,n=i.$refs.refOptionPanel,o.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,n).flag,l&&!o.isActivated&&i.hideOptionPanel())},handleGlobalBlurEvent:function(){this.hideOptionPanel()},focusEvent:function(e){var t=this.reactData;this.computeIsDisabled||t.visiblePanel||(t.triggerFocusPanel=!0,this.showOptionPanel(),setTimeout(function(){t.triggerFocusPanel=!1},150)),this.dispatchEvent("focus",{},e)},clickEvent:function(e){this.togglePanelEvent(e),this.dispatchEvent("click",{},e)},blurEvent:function(e){this.reactData.isActivated=!1,this.dispatchEvent("blur",{},e)},togglePanelEvent:function(e){var t=this.reactData;e.$event.preventDefault(),t.triggerFocusPanel?t.triggerFocusPanel=!1:t.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},nodeClickEvent:function(e){var t=e.$event;this.dispatchEvent("node-click",e,t)},radioChangeEvent:function(e){var t=e.value;this.changeEvent(e.$event,t),this.hideOptionPanel()},checkboxChangeEvent:function(e){var t=e.value;this.changeEvent(e.$event,t)},loadSuccessEvent:function(){this.cacheDataMap()},renderVN:function(e){var t=this,n=t,i=t.$scopedSlots,o=t.reactData,l=n.className,r=n.value,a=n.multiple,u=n.options,s=n.loading,c=o.initialized,p=o.isActivated,d=o.isAniVisible,f=o.visiblePanel,h=t.computeSize,m=t.computeIsDisabled,v=t.computeSelectLabel,g=t.computeBtnTransfer,b=t.computePopupWrapperStyle,_=i.header,x=i.footer,y=i.prefix,i=t.computePopupOpts.className||n.popupClassName,P=t.computeTreeOpts,E=t.computeTreeNodeOpts,O=t.computeTreeCheckboxOpts,C=t.computeTreeRadioOpts,F=t.computeNodeKeyField,T=t.computeLabelField,S=t.computeValueField,I=t.computeChildrenField,D=t.computeParentField,w=t.computeHasChildField;return t.computeFormReadonly?e("div",{ref:"refElem",class:["vxe-tree-select--readonly",l]},[e("span",{class:"vxe-tree-select-label"},v)]):e("div",{ref:"refElem",class:["vxe-tree-select",l?_xeUtils.default.isFunction(l)?l({$treeSelect:t}):l:"",_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(h),h),"is--visible",f),"is--disabled",m),"is--loading",s),"is--active",p)]},[e(_input.default,{ref:"refInput",props:{clearable:n.clearable,placeholder:n.placeholder,readonly:!0,disabled:m,type:"text",prefixIcon:n.prefixIcon,suffixIcon:s?(0,_ui.getIcon)().TREE_SELECT_LOADED:f?(0,_ui.getIcon)().TREE_SELECT_OPEN:(0,_ui.getIcon)().TREE_SELECT_CLOSE,value:s?(0,_ui.getI18n)("vxe.select.loadingText"):v},on:{clear:t.clearEvent,click:t.clickEvent,focus:t.focusEvent,blur:t.blurEvent,"suffix-click":t.togglePanelEvent},scopedSlots:y?{prefix:function(){return y({})}}:{}}),e("div",{ref:"refOptionPanel",class:["vxe-table--ignore-clear vxe-tree-select--panel",i?_xeUtils.default.isFunction(i)?i({$treeSelect:t}):i:"",_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(h),h),"is--transfer",g),"ani--leave",!s&&d),"ani--enter",!s&&f)],attrs:{placement:o.panelPlacement},style:o.panelStyle},c?[e("div",{class:"vxe-tree-select--panel-wrapper"},[_?e("div",{class:"vxe-tree-select--panel-header"},_({})):(0,_ui.renderEmptyElement)(t),e("div",{class:"vxe-tree-select--panel-body"},[e("div",{ref:"refTreeWrapper",class:"vxe-tree-select-tree--wrapper",style:b},[e(_tree.default,{class:"vxe-tree-select--tree",props:{data:u,indent:P.indent,showRadio:!a,radioConfig:C,checkNodeKey:a?null:r,showCheckbox:!!a,checkNodeKeys:a?r:null,checkboxConfig:O,titleField:T,valueField:S,keyField:F,childrenField:P.childrenField||I,parentField:P.parentField||D,hasChildField:P.hasChildField||w,accordion:P.accordion,expandAll:P.expandAll,nodeConfig:E,lazy:P.lazy,loadMethod:P.loadMethod,toggleMethod:P.toggleMethod,transform:P.transform,trigger:P.trigger,showIcon:P.showIcon,showLine:P.showLine,iconOpen:P.iconOpen,iconLoaded:P.iconLoaded,iconClose:P.iconClose},on:{"node-click":t.nodeClickEvent,"radio-change":t.radioChangeEvent,"checkbox-change":t.checkboxChangeEvent,"load-success":t.loadSuccessEvent}})])]),x?e("div",{class:"vxe-tree-select--panel-footer"},x({})):(0,_ui.renderEmptyElement)(t)])]:[])])}},watch:{options:function(){this.cacheDataMap()}},created:function(){this.cacheDataMap()},mounted:function(){var e=this;_ui.globalEvents.on(e,"mousewheel",e.handleGlobalMousewheelEvent),_ui.globalEvents.on(e,"mousedown",e.handleGlobalMousedownEvent),_ui.globalEvents.on(e,"blur",e.handleGlobalBlurEvent)},beforeDestroy:function(){var e=this.$refs.refOptionPanel;e&&e.parentNode&&e.parentNode.removeChild(e),_ui.globalEvents.off(this,"mousewheel"),_ui.globalEvents.off(this,"mousedown"),_ui.globalEvents.off(this,"blur")},render:function(e){return this.renderVN(e)}});