Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeImagePreview",props:{value:Number,urlList:Array,urlField:{type:String,default:function(){return(0,_ui.getConfig)().imagePreview.urlField}},maskClosable:{type:Boolean,default:function(){return(0,_ui.getConfig)().imagePreview.maskClosable}},marginSize:{type:String,default:function(){return(0,_ui.getConfig)().imagePreview.marginSize}},showPrintButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().imagePreview.showPrintButton}},showDownloadButton:{type:Boolean,default:function(){return(0,_ui.getConfig)().imagePreview.showDownloadButton}},toolbarConfig:Object,beforeDownloadMethod:Function,downloadMethod:Function},provide:function(){return{$xeImagePreview:this}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{activeIndex:0,offsetPct11:!1,offsetScale:0,offsetRotate:0,offsetLeft:0,offsetTop:0}}},computed:Object.assign(Object.assign({},{}),{computeUrlProp:function(){return this.urlField||"url"},computeMarginSize:function(){return _xeUtils.default.toNumber(this.marginSize||0)||16},computeToolbarOpts:function(){return Object.assign({},(0,_ui.getConfig)().imagePreview.toolbarConfig,this.toolbarConfig)},computeRotateText:function(){var e=this.reactData.offsetRotate;return e?"".concat(e,"°"):"0°"},computeScaleText:function(){var e=this.reactData.offsetScale;return e?"".concat(_xeUtils.default.ceil(100*(1+e)),"%"):"100%"},computeImgList:function(){var e=this.urlList,t=this.computeUrlProp;return e&&e.length?e.map(function(e){return _xeUtils.default.isString(e)?e:e[t]||""}):[]},computeImgTransform:function(){var e=this.reactData,t=e.offsetScale,n=e.offsetRotate,o=e.offsetLeft,a=e.offsetTop,e=[],i=1;if(t&&e.push("scale(".concat(i=1+t,")")),n&&e.push("rotate(".concat(n,"deg)")),o||a){var r=o/=i,s=a/=i;if(n)switch(n%360){case 90:case-270:r=a,s=-o;break;case 180:case-180:r=-o,s=-a;break;case 270:case-90:r=-a,s=o}e.push("translate(".concat(r,"px, ").concat(s,"px)"))}return e.length?e.join(" "):""}}),methods:{dispatchEvent:function(e,t,n){this.$emit(e,(0,_ui.createEvent)(n,{$imagePreview:this},t))},emitModel:function(e){var t=this,n=t._events;t.$emit("input",e),n&&n.modelValue?t.$emit("modelValue",e):t.$emit("model-value",e)},handleCloseEvent:function(e){this.dispatchEvent("close",{},e)},resetStyle:function(){var e=this.reactData,t=this.$refs.refElem;(0,_dom.removeClass)(t,"is--move"),Object.assign(e,{offsetPct11:!1,offsetScale:0,offsetRotate:0,offsetLeft:0,offsetTop:0})},getOffsetZoomStep:function(){var e=this.reactData.offsetScale,t=.02;return t=-.6<=e&&(t=.04,-.4<=e)&&(t=.07,0<=e)&&(t=.1,3<=e)&&(t=.25,8<=e)&&(t=.4,16<=e)&&(t=.6,24<=e)&&(t=.9,32<=e)&&(t=1.3,39<=e)&&(t=1.9,45<=e)?2.5:t},handleZoom:function(e){var t=this.reactData,n=t.offsetScale,o=this.getOffsetZoomStep();t.offsetScale=e?Number(Math.min(49,n+o).toFixed(2)):Number(Math.max(-.9,n-o).toFixed(2))},handleChange:function(e){var t=this.reactData,n=t.activeIndex||0,o=this.computeImgList;e?n>=o.length-1?n=0:n++:n<=0?n=o.length-1:n--,this.resetStyle(),t.activeIndex=n,this.emitModel(n)},handleRotateImg:function(e){var t=this.reactData,n=t.offsetRotate;e?n+=90:n-=90,t.offsetRotate=n},handlePct11:function(){var e=this.reactData;this.resetStyle(),e.offsetPct11=!0},handlePrintImg:function(){var e=this.reactData.activeIndex,e=this.computeImgList[e||0];_ui.VxeUI.print&&_ui.VxeUI.print({align:"center",pageBreaks:[{bodyHtml:'<img src="'.concat(e,'" style="max-width:100%;max-height:100%;">')}]})},handleDownloadEvent:function(e,t){this.dispatchEvent("download",{url:t},e)},handleDefaultDownload:function(t,n){var o=this;_ui.VxeUI.saveFile&&fetch(n).then(function(e){return e.blob().then(function(e){_ui.VxeUI.saveFile({filename:n,content:e}),o.handleDownloadEvent(t,n)})}).catch(function(){_ui.VxeUI.modal&&_ui.VxeUI.modal.message({content:(0,_ui.getI18n)("vxe.error.downErr"),status:"error"})})},handleDownloadImg:function(t){var n=this,e=n,o=n.reactData.activeIndex,a=n.computeToolbarOpts.download,a=!_xeUtils.default.isBoolean(a)&&a?Object.assign({},a):{},i=n.computeImgList[o||0],r=e.beforeDownloadMethod||a.beforeDownloadMethod||(0,_ui.getConfig)().imagePreview.beforeDownloadMethod,s=e.downloadMethod||a.downloadMethod||(0,_ui.getConfig)().imagePreview.downloadMethod;Promise.resolve(!r||r({$imagePreview:n,url:i,index:o||0})).then(function(e){e&&(s?Promise.resolve(s({$imagePreview:n,url:i,index:o||0})).then(function(){n.handleDownloadEvent(t,i)}).catch(function(e){return e}):n.handleDefaultDownload(t,i))})},handleOperationBtn:function(e,t){var n=this,o=n.reactData.activeIndex;if(n.computeImgList[o||0])switch(t){case"zoomOut":n.handleZoom(!1);break;case"zoomIn":n.handleZoom(!0);break;case"pctFull":n.resetStyle();break;case"pct11":n.handlePct11();break;case"rotateLeft":n.handleRotateImg(!1);break;case"rotateRight":n.handleRotateImg(!0);break;case"print":n.handlePrintImg();break;case"download":n.handleDownloadImg(e)}},wheelEvent:function(e){e=e.deltaY;0<e?this.handleZoom(!1):e<0&&this.handleZoom(!0)},moveEvent:function(e){var i=this.reactData,r=i.offsetTop,s=i.offsetLeft,l=this.$refs.refElem,t=(e.preventDefault(),document.onmousemove),n=document.onmouseup,c=e.pageX,u=e.pageY,d=this.computeMarginSize;document.onmousemove=function(e){var t=e.pageX,n=e.pageY,o=(0,_dom.getDomNode)(),a=o.visibleHeight,o=o.visibleWidth;e.preventDefault(),(0,_dom.addClass)(l,"is--move"),d<t&&d<n&&t<o-d&&n<a-d&&(i.offsetLeft=s+t-c,i.offsetTop=r+n-u)},document.onmouseup=function(){document.onmousemove=t,document.onmouseup=n,(0,_dom.removeClass)(l,"is--move")}},handleGlobalKeydownEvent:function(e){var t=this,n=t.reactData,o=(0,_dom.hasControlKey)(e),a=e.shiftKey,i=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),r=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),s=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_LEFT),l=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_RIGHT),c=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.R),u=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.P);i?(e.preventDefault(),a?--n.offsetTop:t.handleZoom(!0)):r?(e.preventDefault(),a?n.offsetTop+=1:t.handleZoom(!1)):s?(e.preventDefault(),a?--n.offsetLeft:t.handleChange(!1)):l?(e.preventDefault(),a?n.offsetLeft+=1:t.handleChange(!0)):c&&o?(e.preventDefault(),a?t.handleRotateImg(!1):t.handleRotateImg(!0)):u&&o&&(e.preventDefault(),t.handlePrintImg())},handleClickMaskEvent:function(e){this.maskClosable&&e.target===e.currentTarget&&this.dispatchEvent("close",{},e)},renderImgWrapper:function(n){var o=this,a=o.reactData.activeIndex,e=o.computeImgList,i=o.computeImgTransform;return n("div",{class:"vxe-image-preview--img-list",on:{click:o.handleClickMaskEvent}},e.map(function(e,t){t=a===t;return n("img",{class:["vxe-image-preview--img-item",{"is--active":t}],style:t?{transform:i}:{},attrs:{src:e},on:{mousedown:function(e){o.moveEvent(e)}}})}))},renderOperationBtn:function(e,t,n){var o=this,a=o.computeToolbarOpts[t],i=!_xeUtils.default.isBoolean(a)&&a?Object.assign({},a):{};return!1!==a?e("div",{class:"vxe-image-preview--operation-btn",attrs:{title:(0,_ui.getI18n)("vxe.imagePreview.operBtn.".concat(t))},on:{click:function(e){o.handleOperationBtn(e,t)}}},[e("i",{class:i.icon||(0,_ui.getIcon)()[n]})]):(0,_ui.renderEmptyElement)(o)},renderBtnWrapper:function(e){var t=this,n=t.reactData,o=t.showPrintButton,a=t.showDownloadButton,n=n.activeIndex,i=t.computeImgList,r=t.computeRotateText,s=t.computeScaleText,l=t.computeToolbarOpts;return e("div",{class:"vxe-image-preview--btn-wrapper"},[e("div",{class:"vxe-image-preview--close-wrapper"},[e("div",{class:"vxe-image-preview--close-btn",on:{click:t.handleCloseEvent}},[e("i",{class:(0,_ui.getIcon)().IMAGE_PREVIEW_CLOSE})]),e("div",{class:"vxe-image-preview--close-bg"})]),1<i.length?e("div",{class:"vxe-image-preview--previous-btn",on:{click:function(){t.handleChange(!1)}}},[e("i",{class:(0,_ui.getIcon)().IMAGE_PREVIEW_PREVIOUS})]):(0,_ui.renderEmptyElement)(t),1<i.length?e("div",{class:"vxe-image-preview--next-btn",on:{click:function(){t.handleChange(!0)}}},[e("i",{class:(0,_ui.getIcon)().IMAGE_PREVIEW_NEXT})]):(0,_ui.renderEmptyElement)(t),e("div",{class:"vxe-image-preview--operation-info"},[e("div",{class:"vxe-image-preview--operation-deg"},r),e("div",{class:"vxe-image-preview--operation-pct"},s)]),e("div",{class:"vxe-image-preview--operation-wrapper"},[e("div",{class:"vxe-image-preview--operation-active-count"},[e("span",{class:"vxe-image-preview--operation-active-current"},"".concat((n||0)+1)),e("span",{class:"vxe-image-preview--operation-active-total"},"/".concat(i.length))]),t.renderOperationBtn(e,"zoomOut","IMAGE_PREVIEW_ZOOM_OUT"),t.renderOperationBtn(e,"zoomIn","IMAGE_PREVIEW_ZOOM_IN"),t.renderOperationBtn(e,"pctFull","IMAGE_PREVIEW_PCT_FULL"),t.renderOperationBtn(e,"pct11","IMAGE_PREVIEW_PCT_1_1"),t.renderOperationBtn(e,"rotateLeft","IMAGE_PREVIEW_ROTATE_LEFT"),t.renderOperationBtn(e,"rotateRight","IMAGE_PREVIEW_ROTATE_RIGHT"),o||l.print?t.renderOperationBtn(e,"print","IMAGE_PREVIEW_PRINT"):(0,_ui.renderEmptyElement)(t),a||l.download?t.renderOperationBtn(e,"download","IMAGE_PREVIEW_DOWNLOAD"):(0,_ui.renderEmptyElement)(t)])])},renderVN:function(e){return e("div",{ref:"refElem",class:["vxe-image-preview",{"is--pct11":this.reactData.offsetPct11}],on:{wheel:this.wheelEvent}},[this.renderImgWrapper(e),this.renderBtnWrapper(e)])}},watch:{value:function(e){this.reactData.activeIndex=e,this.resetStyle()}},created:function(){this.reactData.activeIndex=this.value||0},mounted:function(){_ui.globalEvents.on(this,"keydown",this.handleGlobalKeydownEvent)},beforeDestroy:function(){var e=this.$refs.refElem;e&&(0,_dom.removeClass)(e,"is--move"),_ui.globalEvents.off(this,"keydown")},render:function(e){return this.renderVN(e)}});