Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_util=require("./util"),_tooltip=_interopRequireDefault(require("../../tooltip/src/tooltip")),_formConfigItem=_interopRequireDefault(require("./form-config-item")),_loading=_interopRequireDefault(require("../../loading/src/loading")),_vn=require("../../ui/src/vn"),_log=require("../../ui/src/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);i=i.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}var Rule=(()=>_createClass(function e(t){_classCallCheck(this,e),Object.assign(this,{$options:t,required:t.required,min:t.min,max:t.min,type:t.type,pattern:t.pattern,validator:t.validator,trigger:t.trigger,maxWidth:t.maxWidth})},[{key:"content",get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}]))();function validREValue(e,t){return!(e&&!(_xeUtils.default.isRegExp(e)?e:new RegExp(e)).test(t))}function validMaxValue(e,t){return!(!_xeUtils.default.eqNull(e)&&t>_xeUtils.default.toNumber(e))}function validMinValue(e,t){return!(!_xeUtils.default.eqNull(e)&&t<_xeUtils.default.toNumber(e))}function validRuleValue(e,t,i){var r=e.type,n=e.min,o=e.max,e=e.pattern,l="array"===r,a="number"===r,r="string"===r,u="".concat(t);if(!validREValue(e,u))return!1;if(l){if(!_xeUtils.default.isArray(t))return!1;if(i&&!t.length)return!1;if(!validMinValue(n,t.length))return!1;if(!validMaxValue(o,t.length))return!1}else if(a){e=Number(t);if(isNaN(e))return!1;if(!validMinValue(n,e))return!1;if(!validMaxValue(o,e))return!1}else{if(r&&!_xeUtils.default.isString(t))return!1;if(i&&!u)return!1;if(!validMinValue(n,u.length))return!1;if(!validMaxValue(o,u.length))return!1}return!0}function checkRuleStatus(e,t){var i=e.required,r=_xeUtils.default.isArray(t)?!t.length:(0,_utils.eqEmptyValue)(t);if(i){if(r)return!1;if(!validRuleValue(e,t,i))return!1}else if(!r&&!validRuleValue(e,t,i))return!1;return!0}var _default2=exports.default=(0,_comp.defineVxeComponent)({name:"VxeForm",mixins:[_ui.globalMixins.sizeMixin],props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return(0,_ui.getConfig)().form.size||(0,_ui.getConfig)().size}},span:{type:[String,Number],default:function(){return(0,_ui.getConfig)().form.span}},align:{type:String,default:function(){return(0,_ui.getConfig)().form.align}},verticalAlign:{type:String,default:function(){return(0,_ui.getConfig)().form.verticalAlign}},border:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.border}},titleBackground:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.titleBackground}},titleBold:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.titleBold}},titleAlign:{type:String,default:function(){return(0,_ui.getConfig)().form.titleAlign}},titleWidth:{type:[String,Number],default:function(){return(0,_ui.getConfig)().form.titleWidth}},titleColon:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:function(){return(0,_ui.getConfig)().form.titleOverflow}},vertical:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.vertical}},padding:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.padding}},className:[String,Function],readonly:Boolean,disabled:Boolean,items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.preventSubmit}},validConfig:Object,tooltipConfig:Object,collapseConfig:Object,customLayout:{type:Boolean,default:function(){return(0,_ui.getConfig)().form.customLayout}}},inject:{$xeGrid:{default:null}},provide:function(){return{$xeForm:this,xeFormItemInfo:null,$xeFormGroup:null,$xeFormItem:null}},data:function(){return{xID:_xeUtils.default.uniqueId(),reactData:{collapseAll:!1,staticItems:[],formItems:[]},internalData:{meTimeout:void 0,stTimeout:void 0,tooltipStore:{item:null,visible:!1},itemFormatCache:{}}}},computed:Object.assign(Object.assign({},{}),{computeValidOpts:function(){return Object.assign({},(0,_ui.getConfig)().form.validConfig,this.validConfig)},computeTooltipOpts:function(){return Object.assign({},(0,_ui.getConfig)().tooltip,(0,_ui.getConfig)().form.tooltipConfig,this.tooltipConfig)},computeCollapseOpts:function(){return Object.assign({},(0,_ui.getConfig)().form.collapseConfig,this.collapseConfig)}}),methods:{dispatchEvent:function(e,t,i){this.$emit(e,(0,_ui.createEvent)(i,{$form:this},t))},callSlot:function(e,t,i){var r=this.$scopedSlots;return e&&(_xeUtils.default.isString(e)&&(e=r[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e.call(this,t,i)):[]},loadItem:function(e){var t=this,i=t.$scopedSlots,r=t.reactData,n=t.internalData;return e.length&&e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||i[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})}),r.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(t,e)},{children:"children"}),n.itemFormatCache={},t.$nextTick()},getItems:function(){var e=this.reactData,t=[];return _xeUtils.default.eachTree(e.formItems,function(e){t.push(e)},{children:"children"}),t},getItemByField:function(t){var e=this.reactData,e=_xeUtils.default.findTree(e.formItems,function(e){return e.field===t},{children:"children"});return e?e.item:null},getCollapseStatus:function(){return this.reactData.collapseAll},toggleCollapse:function(){var e=this.reactData,t=!this.getCollapseStatus();return e.collapseAll=t,this.$emit("update:collapseStatus",t),this.$nextTick()},toggleCollapseEvent:function(e){var t=this,i=t,r=t.$xeGrid,n=(t.toggleCollapse(),t.getCollapseStatus());t.dispatchEvent("toggle-collapse",{status:n,collapse:n,data:i.data},e),t.dispatchEvent("collapse",{status:n,collapse:n,data:i.data},e),t.$nextTick(function(){r&&r.recalculate()})},clearValidate:function(e){var t,i=this;return e?(t=_xeUtils.default.isArray(t=e)?t:[e]).forEach(function(e){e&&(e=(0,_util.handleFieldOrItem)(i,e))&&(e.showError=!1)}):i.getItems().forEach(function(e){e.showError=!1}),i.$nextTick()},getResetValue:function(e,t,i){var r=this.$xeGrid,n=e.field,o=e.resetValue;return _xeUtils.default.isFunction(o)?o({field:n,item:e,data:t,$form:this,$grid:r}):null===o&&_xeUtils.default.isArray(i)?[]:o},reset:function(){var l=this,a=l.$xeGrid,e=l.internalData,u=l.data,t=l.getItems();return u&&t.forEach(function(e){var t,i,r,n=e.field,o=e.itemRender;(0,_utils.isEnableConf)(o)&&(r=o.name,t=o.startField,o=o.endField,i=(r=_ui.renderer.get(r))?r.formItemResetMethod||r.itemResetMethod:null,r&&i?i({data:u,field:n,property:n,item:e,$form:l,$grid:a}):n&&(r=_xeUtils.default.get(u,n),_xeUtils.default.set(u,n,l.getResetValue(e,u,r))),t)&&o&&(_xeUtils.default.set(u,t,l.getResetValue(e,u,_xeUtils.default.get(u,t))),_xeUtils.default.set(u,o,l.getResetValue(e,u,_xeUtils.default.get(u,o))))}),e.itemFormatCache={},l.clearValidate()},resetEvent:function(e){e.preventDefault(),this.reset(),this.dispatchEvent("reset",{data:this.data},e)},handleFocus:function(e){var t=this,i=t,r=t.$xeGrid,n=t.$refs.refElem;if(n)for(var o=0;o<e.length;o++){var l=e[o],a=t.getItemByField(l);if(a&&(0,_utils.isEnableConf)(a.itemRender)){var u=a.itemRender,s=_ui.renderer.get(u.name),f=(o||(0,_dom.scrollToView)(n.querySelector(".".concat(a.id))),null),u=u.autoFocus||u.autofocus||(s?s.formItemAutoFocus:null);if(_xeUtils.default.isFunction(u)?f=u({$form:t,$grid:r,item:a,data:i.data,field:l}):!0===u?f=n.querySelector(".".concat(a.id," input,textarea")):u&&(f=n.querySelector(".".concat(a.id," ").concat(u))),f){f.focus();break}}}},validItemRules:function(c,e,t){var d=this,m=d.data,i=d.rules,r={};return _xeUtils.default.isArray(e)||(e=[e]),Promise.all(e.map(function(l){var a,u,s=[],f=[];return l&&i&&(a=_xeUtils.default.get(i,l))&&(u=_xeUtils.default.isUndefined(t)?_xeUtils.default.get(m,l):t,a.forEach(function(t){var e,i,r,n=t.trigger,o=t.validator;"all"!==c&&n&&c!==n||(o?(e={itemValue:u,rule:t,rules:a,data:m,field:l,property:l,$form:d},_xeUtils.default.isString(o)?(r=_ui.validators.get(o))?(r=r.formItemValidatorMethod||r.itemValidatorMethod)?i=r(e):(0,_log.warnLog)("vxe.error.notValidators",[o]):(0,_log.errLog)("vxe.error.notValidators",[o]):i=o(e),i&&(_xeUtils.default.isError(i)?s.push(new Rule({type:"custom",trigger:n,content:i.message,rule:new Rule(t)})):i.catch&&f.push(i.catch(function(e){s.push(new Rule({type:"custom",trigger:n,content:e?e.message:t.content||t.message,rule:new Rule(t)}))})))):checkRuleStatus(t,u)||s.push(new Rule(t)))})),Promise.all(f).then(function(){s.length&&(r[l]=s.map(function(e){return{$form:d,rule:e,data:m,field:l,property:l}}))})})).then(function(){if(!_xeUtils.default.isEmpty(r))return Promise.reject(r)})},beginValidate:function(t,e,i){var r=this,n=r.internalData,o=r.data,l=r.rules,a=r.computeValidOpts,u={},s=[],f=[];return clearTimeout(n.meTimeout),o&&l?(t.forEach(function(t){var i=t.field;i&&!(0,_util.isHiddenItem)(r,t)&&(0,_util.isActiveItem)(r,t)&&f.push(r.validItemRules(e||"all",i).then(function(){t.errRule=null}).catch(function(e){e=e[i];return u[i]||(u[i]=[]),u[i].push(e),s.push(i),t.errRule=e[0].rule,Promise.reject(e)}))}),Promise.all(f).then(function(){i&&i()}).catch(function(){return new Promise(function(e){n.meTimeout=setTimeout(function(){t.forEach(function(e){e.errRule&&(e.showError=!0)})},20),!1!==a.autoPos&&r.$nextTick(function(){r.handleFocus(s)}),i?(i(u),e()):e(u)})})):(i&&i(),Promise.resolve())},validate:function(e){var t=this,i=t.readonly;return t.clearValidate(),i?t.$nextTick():t.beginValidate(t.getItems(),"",e)},validateField:function(e,t){var i,r=this;return r.readonly?r.$nextTick():(i=[],e&&(i=_xeUtils.default.isArray(e)?e:[e]),r.beginValidate(i.map(function(e){return(0,_util.handleFieldOrItem)(r,e)}),"",t))},submitEvent:function(t){var i=this,r=i,e=r.readonly;t.preventDefault(),r.preventSubmit||(i.clearValidate(),e?i.dispatchEvent("submit",{data:r.data},t):i.beginValidate(i.getItems()).then(function(e){e?i.dispatchEvent("submit-invalid",{data:r.data,errMap:e},t):i.dispatchEvent("submit",{data:r.data},t)}))},closeTooltip:function(){var e=this.internalData.tooltipStore,t=this.$refs.refTooltip;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t)&&t.close(),this.$nextTick()},triggerTitleTipEvent:function(e,t){var i=this.internalData,t=t.item,r=i.tooltipStore,n=this.$refs.refTooltip,e=e.currentTarget.children[0],o=(e.textContent||"").trim(),l=e.scrollWidth>e.clientWidth;clearTimeout(i.stTimeout),r.item!==t&&this.closeTooltip(),o&&l&&(Object.assign(r,{item:t,visible:!0}),n)&&n.open(e,o)},handleTitleTipLeaveEvent:function(){var e=this,t=e.internalData,i=e.computeTooltipOpts,r=e.$refs.refTooltip;r&&r.setActived(!1),i.enterable?t.stTimeout=setTimeout(function(){(r=e.$refs.refTooltip)&&!r.isActived()&&e.closeTooltip()},i.leaveDelay):e.closeTooltip()},triggerItemEvent:function(e,i,t){var r=this;return i?r.validItemRules(e?["blur"].includes(e.type)?"blur":"change":"all",i,t).then(function(){r.clearValidate(i)}).catch(function(e){var e=e[i],t=r.getItemByField(i);e&&t&&(t.showError=!0,t.errRule=e[0].rule)}):r.$nextTick()},updateStatus:function(e,t){e=e.field;return this.triggerItemEvent(new Event("change"),e,t)},renderVN:function(i){var e=this,t=e.$scopedSlots,r=e.loading,n=e.border,o=e.className,l=e.data,a=e.customLayout,u=e.reactData.formItems,s=e.computeSize,f=e.computeTooltipOpts,t=t.default;return i("form",{ref:"refElem",class:["vxe-form",o?_xeUtils.default.isFunction(o)?o({items:u,data:l,$form:e}):o:"",_defineProperty(_defineProperty(_defineProperty(_defineProperty({},"size--".concat(s),s),"is--border",n),"custom--layout",a),"is--loading",r)],on:{submit:e.submitEvent,reset:e.resetEvent}},[i("div",{class:"vxe-form--wrapper vxe-form--item-row"},a?t?t({}):[]:u.map(function(e,t){return i(_formConfigItem.default,{key:t,props:{itemConfig:e}})})),i("div",{class:"vxe-form-slots",ref:"hideItem"},!a&&t?t({}):[]),i(_loading.default,{class:"vxe-form--loading",props:{value:r}}),i(_tooltip.default,Object.assign({ref:"refTooltip"},f))])}},watch:{"reactData.staticItems":function(){var e=this.reactData;e.formItems=e.staticItems},items:function(){this.loadItem(this.items||[])},collapseStatus:function(e){this.reactData.collapseAll=!!e},readonly:function(){this.clearValidate()},disabled:function(){this.clearValidate()}},created:function(){this.reactData.collapseAll=!!this.collapseStatus},mounted:function(){var e=this;e.items&&this.loadItem(e.items),this.$nextTick(function(){e.customLayout&&e.items&&(0,_log.errLog)("vxe.error.errConflicts",["custom-layout","items"])})},render:function(e){return this.renderVN(e)}});