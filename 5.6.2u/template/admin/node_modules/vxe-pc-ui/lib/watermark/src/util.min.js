Object.defineProperty(exports,"__esModule",{value:!0}),exports.getContentUrl=getContentUrl;var _xeUtils=_interopRequireDefault(require("xe-utils")),_dom=require("../../ui/src/dom");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){var n;if(t)return"string"==typeof t?_arrayLikeToArray(t,e):"Map"===(n="Object"===(n={}.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,a,l,i=[],c=!0,f=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(i.push(r.value),i.length!==e);c=!0);}catch(t){f=!0,o=t}finally{try{if(!c&&null!=n.return&&(l=n.return(),Object(l)!==l))return}finally{if(f)throw o}}return i}}function _arrayWithHoles(t){if(Array.isArray(t))return t}var canvasEl=null,fontEl=null,fontCacheMaps={};function getMarkCanvas(){return canvasEl||((canvasEl=document.createElement("canvas")).style.position="absolute",canvasEl.style.top="0",canvasEl.style.left="0"),canvasEl}function removeMarkElement(t){var e;t&&(e=t.parentNode)&&e.removeChild(t)}function calcFontWH(t,e){var n="".concat(e,"_").concat(t);return fontCacheMaps[n]||((fontEl=fontEl||document.createElement("span")).parentNode||document.body.append(fontEl),fontEl.textContent=t,fontEl.style.fontSize=(0,_dom.toCssUnit)(e),t=fontEl.offsetWidth,e=fontEl.offsetHeight,fontCacheMaps[n]={width:t,height:e}),fontCacheMaps[n]}function calcContentWH(t){var e=0,n=0;return t.forEach(function(t){e=Math.max(t.width,e),n=Math.max(t.height,n)}),{contentWidth:e,contentHeight:n}}function calcCanvasWH(t,e){var e=e.gap,e=_slicedToArray(e?_xeUtils.default.isArray(e)?e:[e,e]:[],2),n=e[0],e=e[1],e=void 0===e?0:e;return{canvasWidth:t+_xeUtils.default.toNumber(void 0===n?0:n),canvasHeight:t+_xeUtils.default.toNumber(e)}}function getFontConf(t,e,n){return(t.font?t.font[e]:"")||(n.font?n.font[e]:"")}function createMarkFont(t,e,n){var r=n.offset,o=_xeUtils.default.toValueString(t.textContent),n=_xeUtils.default.toNumber(getFontConf(t,"fontSize",n)||e)||14,e=_slicedToArray(r?_xeUtils.default.isArray(r)?r:[r,r]:[],2),r=e[0],r=void 0===r?0:r,e=e[1],e=void 0===e?0:e,a=calcFontWH(o,n),l=a.width,a=a.height;return{text:o,fontSize:n,font:t.font,width:l+_xeUtils.default.toNumber(r),height:a+_xeUtils.default.toNumber(e)}}function drayFont(t,e,n){var r=getFontConf(e,"fontWeight",n);t.fillStyle="".concat(getFontConf(e,"color",n)||"rgba(0, 0, 0, 0.15)"),t.font=[getFontConf(e,"fontStyle",n)||"normal","bold"===r||"bolder"===r?"bold":"",(0,_dom.toCssUnit)(e.fontSize),getFontConf(e,"fontFamily",n)||"sans-serif"].join(" ")}function getContentUrl(t,e,n){var u=Object.assign({},n),n=u.rotate,s=_xeUtils.default.toNumber(n),d=(_xeUtils.default.isArray(t)?t:[t]).map(function(t){return t?t.textContent?createMarkFont(t,e,u):createMarkFont({textContent:"".concat(t)},e,u):createMarkFont({textContent:""},e,u)});return removeMarkElement(fontEl),new Promise(function(t){var n,r,o,a,e,l,i,c=getMarkCanvas(),f=(c.parentNode||document.body.append(c),c.getContext("2d"));f&&d.length?(l=calcContentWH(d),n=l.contentWidth,r=l.contentHeight,e=(l=calcCanvasWH(n,u)).canvasWidth,l=l.canvasHeight,c.width=e,c.height=l,e=(o=(e-n)/2)+n/2,l=(a=(l-r)/2)+r/2,f.save(),f.translate(e,l),f.rotate(s*Math.PI/180),f.translate(-e,-l),i=0,d.forEach(function(t){var e=getFontConf(t,"align",u);drayFont(f,t,u),f.fillText(t.text,o+("center"===e?(n-t.width)/2:0),a+(r+r)/2+i,n),i+=t.height}),f.restore(),t(c.toDataURL())):t(""),removeMarkElement(c)})}